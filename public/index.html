<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Battle Manager v7.25</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg-color: #f0f2f5; --side-bg: #ffffff; --player-accent: #4361ee; --enemy-accent: #e63946; --heal-accent: #2a9d8f; --dice-accent: #8e44ad; --turn-active: #00d2ff; --text-main: #2d3436; --border: #dfe6e9; --skill-accent: #6c5ce7; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Pretendard', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .side-panel { width: 350px; display: flex; flex-direction: column; background: var(--side-bg); border: 1px solid var(--border); }
        .char-scroll-area { flex: 1; overflow-y: auto; padding: 12px; }
        .center-panel { flex: 1; display: flex; flex-direction: column; padding: 12px; gap: 10px; overflow: hidden; }
        .char-card { background: #fff; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); position: relative; transition: 0.3s; }
        .char-card.active-turn { border: 3px solid var(--turn-active); box-shadow: 0 0 15px rgba(0, 210, 255, 0.5); }
        .char-card.turn-ended { opacity: 0.5; background: #f8f9fa; }
        .char-card.is-ko { filter: grayscale(1); opacity: 0.6; pointer-events: none; }
        .ko-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); background: rgba(0,0,0,0.8); color: #ff4757; padding: 5px 15px; border: 2px solid #ff4757; font-weight: 900; z-index: 100; display: none; border-radius: 4px; }
        .char-card.is-ko .ko-badge { display: block; }
        .card-header { padding: 12px; cursor: pointer; border-radius: 12px; }
        .card-body { overflow: hidden; max-height: 0; transition: max-height 0.4s ease; padding: 0 12px; opacity: 0; }
        .card-body.expanded { max-height: 2000px; padding: 12px; border-top: 1px solid #f1f1f1; opacity: 1; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 12px; }
        .stat-item { display: flex; align-items: center; justify-content: space-between; font-size: 11px; }
        .stat-item input { width: 42px; border: none; border-bottom: 1px solid #ddd; text-align: right; font-weight: 600; background: transparent; }
        .init-input { width: 50px !important; color: var(--turn-active); border-bottom: 2px solid var(--turn-active) !important; font-weight: 900 !important; text-align: center; }
        .hp-bar-outer { width: 100%; height: 6px; background: #eee; border-radius: 10px; margin-top: 5px; overflow: hidden; }
        .hp-bar-inner { height: 100%; width: 100%; transition: 0.5s; }
        .turn-display { background: #2d3436; color: white; padding: 8px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .log-area { flex: 1; background: #fff; border-radius: 10px; padding: 10px; overflow-y: auto; border: 2px solid var(--border); font-size: 12.5px; }
        .log-line { margin-bottom: 4px; padding: 4px 8px; border-radius: 4px; border-left: 4px solid #eee; background: #fcfcfc; }
        .log-round { background: #2d3436; color: #fff; text-align: center; font-weight: 800; margin: 10px 0; border: none; }
        .log-atk { border-left-color: var(--enemy-accent); }
        .log-heal { border-left-color: var(--heal-accent); }
        .log-crit { border-left-color: #ff9f43; background: #fff5eb; font-weight: bold; animation: shake 0.2s ease-in-out 2; }
        .log-death { border-left-color: #000; background: #ffebeb; color: #d63031; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(3px); } 50% { transform: translateX(-3px); } 100% { transform: translateX(0); } }
        .control-row { display: flex; gap: 8px; height: 180px; }
        .control-box { flex: 1; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; position: relative; }
        .custom-select { width: 100%; padding: 6px; border: 1px solid #eee; border-radius: 5px; margin-bottom: 4px; font-size: 11px; cursor: pointer; background: #f9f9f9; }
        .dropdown-menu { display: none; position: absolute; background: #fff; width: 150px; z-index: 500; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-height: 250px; overflow-y: auto; }
        .dropdown-menu div { padding: 8px; cursor: pointer; font-size: 11px; border-bottom: 1px solid #eee; }
        .dropdown-menu div:hover { background: #f0f2f5; }
        .target-tag { display: inline-flex; align-items: center; background: #e2e8f0; padding: 2px 6px; margin: 2px; border-radius: 4px; font-size: 10px; }
        .target-tag b { margin-left: 5px; color: #e63946; cursor: pointer; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; background: white; z-index: 1000; border-radius: 12px; padding: 20px; display: none; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index: 999; display: none; }
        button { cursor: pointer; border: none; font-weight: 700; border-radius: 5px; }
        .btn-action { width: 100%; padding: 10px; color: white; margin-top: auto; font-size: 11px; }
        .status-badge { display: flex; justify-content: space-between; align-items: center; background: #f1f2f6; padding: 4px 8px; border-radius: 6px; margin-bottom: 3px; font-size: 10px; border-left: 3px solid var(--player-accent); }
        .status-badge.skip { border-left-color: #000; background: #dfe6e9; }
        .skill-group { margin-bottom: 12px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        .skill-group-header { background: #f8f9fa; padding: 6px 10px; font-size: 12px; font-weight: 800; border-bottom: 1px solid #eee; }
        .is-viewer .admin-control { display: none !important; }
    </style>
</head>
<body onclick="closeMenus()" class="is-viewer">

<div id="masterBadge" style="position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:2000; padding:5px 15px; border-radius:20px; font-size:12px; font-weight:bold; cursor:pointer; background:#636e72; color:white;" onclick="askMasterPassword()">ğŸ‘€ ê´€ì „ì ëª¨ë“œ (ì¸ì¦ ëŒ€ê¸°)</div>
<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="statusManagerMenu" class="modal">
    <h4>âœ¨ ìƒíƒœì´ìƒ ì„¤ì •</h4>
    <div style="display:flex; flex-direction:column; gap:8px;">
        <input type="text" id="msName" placeholder="íš¨ê³¼ëª… (ì˜ˆ: í™”ìƒ, ê¸°ì ˆ)" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
        <div style="display:flex; gap:5px;">
            <select id="msStat" style="flex:1.2; padding:8px; border:1px solid #ddd; border-radius:6px;">
                <option value="atk">ê³µê²©ë ¥ %</option><option value="hit">ëª…ì¤‘ë¥  %</option><option value="eva">íšŒí”¼ìœ¨ %</option><option value="dot">ì§€ì†í”¼í•´(DOT)</option><option value="hot">ì§€ì†íšŒë³µ(HOT)</option><option value="skip">â›” í–‰ë™ ë¶ˆê°€</option>
            </select>
            <input type="number" id="msPower" placeholder="ìˆ˜ì¹˜" style="flex:0.8; padding:8px; border:1px solid #ddd; border-radius:6px;">
        </div>
        <input type="number" id="msTurn" placeholder="ì§€ì† í„´ (0ì€ ì˜êµ¬)" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
        <button onclick="addNewStatusType()" style="background:var(--player-accent); color:white; padding:10px;">ë“±ë¡</button>
    </div>
    <div id="statusTypeList" style="margin-top:15px; max-height:150px; overflow-y:auto; border-top:1px solid #eee; padding-top:10px;"></div>
    <button onclick="toggleModal('statusManagerMenu', false)" style="width:100%; margin-top:10px; padding:8px; background:#eee;">ë‹«ê¸°</button>
</div>

<div id="itemManagerMenu" class="modal">
    <h4>ğŸ’Š ì•„ì´í…œ ë“±ë¡</h4>
    <div style="display:flex; flex-direction:column; gap:8px;">
        <input type="text" id="itemName" placeholder="ì•„ì´í…œ ì´ë¦„" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
        <input type="number" id="itemPower" placeholder="HP íšŒë³µëŸ‰" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
        <button onclick="addNewItemType()" style="background:var(--heal-accent); color:white; padding:10px;">ì•„ì´í…œ ì¶”ê°€</button>
    </div>
    <div id="itemTypeList" style="margin-top:15px; max-height:150px; overflow-y:auto; border-top:1px solid #eee;"></div>
    <button onclick="toggleModal('itemManagerMenu', false)" style="width:100%; margin-top:10px; padding:8px; background:#eee;">ë‹«ê¸°</button>
</div>

<div id="itemUseMenu" class="modal">
    <h4>ğŸ’ ì•„ì´í…œ ì‚¬ìš©</h4>
    <div style="display:flex; flex-direction:column; gap:8px;">
        <div class="custom-select" onclick="openSelect(event, 'itemUseSrcList')" id="itemUseSrcBtn">ì‚¬ìš©ì ì„ íƒ</div>
        <div id="itemUseSrcList" class="dropdown-menu"></div>
        <div class="custom-select" onclick="openSelect(event, 'itemUseSelList')" id="itemUseSelBtn">ì•„ì´í…œ ì„ íƒ</div>
        <div id="itemUseSelList" class="dropdown-menu"></div>
        <div class="custom-select" onclick="openSelect(event, 'itemUseTarList')" id="itemUseTarBtn">ëŒ€ìƒ ì¶”ê°€</div>
        <div id="itemUseTarList" class="dropdown-menu"></div>
        <div id="itemUseTarTags" style="min-height:20px;"></div>
        <button onclick="executeItemUse()" style="background:var(--heal-accent); color:white; padding:12px; margin-top:10px;">ì‹¤í–‰í•˜ê¸°</button>
    </div>
    <button onclick="toggleModal('itemUseMenu', false)" style="width:100%; margin-top:15px; padding:8px; background:#eee;">ë‹«ê¸°</button>
</div>

<div id="skillMemoMenu" class="modal" style="width:500px;">
    <h4>ğŸ“œ ìŠ¤í‚¬ ë©”ëª¨</h4>
    <div class="admin-control" style="background:#f8f9fa; padding:12px; border-radius:10px; margin-bottom:15px;">
        <div style="display:flex; gap:5px; margin-bottom:8px;">
            <div class="custom-select" onclick="openSelect(event, 'skillOwnerList')" id="skillOwnerBtn" style="flex:1; background:#fff;">ëŒ€ìƒ ì„ íƒ</div>
            <div id="skillOwnerList" class="dropdown-menu"></div>
            <select id="skType" style="flex:0.6; padding:6px; border:1px solid #ddd; border-radius:5px;">
                <option value="ê³ ìœ ì£¼ìˆ ">ê³ ìœ ì£¼ìˆ </option><option value="ì¼ë°˜" selected>ì¼ë°˜</option><option value="ìœ ì¼ìˆ ì‹">ìœ ì¼ìˆ ì‹</option>
            </select>
        </div>
        <input type="text" id="skName" placeholder="ìŠ¤í‚¬ëª…" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; margin-bottom:8px; box-sizing:border-box;">
        <textarea id="skDesc" placeholder="íš¨ê³¼ ì„¤ëª…" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; height:60px; resize:none; box-sizing:border-box;"></textarea>
        <button onclick="addNewSkill()" style="width:100%; background:var(--skill-accent); color:white; padding:10px;">ë©”ëª¨ ì¶”ê°€</button>
    </div>
    <div id="skillListArea" style="max-height:350px; overflow-y:auto;"></div>
    <button onclick="toggleModal('skillMemoMenu', false)" style="width:100%; margin-top:15px; padding:8px; background:#eee;">ë‹«ê¸°</button>
</div>

<div class="side-panel">
    <div style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:var(--player-accent);">PLAYERS</h3>
        <button class="admin-control" onclick="createUnit('player'); broadcastData();" style="background:var(--player-accent); color:white; width:30px; height:30px; border-radius:50%;">+</button>
    </div>
    <div id="playerList" class="char-scroll-area"></div>
</div>

<div class="center-panel">
    <div class="turn-display">
        <div><b>ROUND <span id="roundNum">1</span></b></div>
        <div style="display:flex; gap:8px;">
            <button class="admin-control" onclick="startFirstTurn()" style="background:var(--turn-active); color:#2d3436; padding:5px 12px;">ì „íˆ¬ ì‹œì‘</button>
            <button class="admin-control" onclick="processRoundEnd()" style="background:var(--enemy-accent); color:white; padding:5px 12px;">ë¼ìš´ë“œ ì¢…ë£Œ</button>
        </div>
    </div>

    <div class="control-row admin-control">
        <div class="control-box">
            <h6 style="margin:0 0 8px 0; color:var(--enemy-accent);">âš”ï¸ ATTACK</h6>
            <div class="custom-select" onclick="openSelect(event, 'atkSrcList')" id="atkSrcBtn">ê³µê²©ì</div>
            <div id="atkSrcList" class="dropdown-menu"></div>
            <div class="custom-select" onclick="openSelect(event, 'atkTarList')" id="atkTarBtn">ëŒ€ìƒ ì¶”ê°€</div>
            <div id="atkTarList" class="dropdown-menu"></div>
            <div id="atkTarTags" style="overflow-y:auto; flex:1;"></div>
            <button class="btn-action" style="background:#2d3436;" onclick="executeAction('attack')">ATTACK</button>
        </div>
        <div class="control-box" style="background:#fbf9ff; border:2px dashed var(--dice-accent);">
            <h6 style="margin:0 0 8px 0; color:var(--dice-accent);">ğŸ² DICE</h6>
            <input type="text" id="diceType" placeholder="1d100" style="padding:6px; border:1px solid #ddd; border-radius:5px; margin-bottom:5px; text-align:center;">
            <input type="number" id="diceSuccess" placeholder="ì„±ê³µê°’" style="padding:6px; border:1px solid #ddd; border-radius:5px; margin-bottom:5px; text-align:center;">
            <button class="btn-action" style="background:var(--dice-accent);" onclick="rollDice()">ROLL</button>
        </div>
        <div class="control-box">
            <h6 style="margin:0 0 8px 0; color:var(--heal-accent);">ğŸ’Š HEAL</h6>
            <div class="custom-select" onclick="openSelect(event, 'healSrcList')" id="healSrcBtn">ì‚¬ìš©ì</div>
            <div id="healSrcList" class="dropdown-menu"></div>
            <div class="custom-select" onclick="openSelect(event, 'healTarList')" id="healTarBtn">ëŒ€ìƒ ì¶”ê°€</div>
            <div id="healTarList" class="dropdown-menu"></div>
            <div id="healTarTags" style="overflow-y:auto; flex:1;"></div>
            <button class="btn-action" style="background:var(--heal-accent);" onclick="executeAction('heal')">HEAL</button>
        </div>
    </div>

    <div class="admin-control" style="display:flex; gap:8px;">
        <button onclick="toggleModal('statusManagerMenu', true)" style="flex:1; background:#34495e; color:white; padding:10px;">âš™ï¸ ìƒíƒœì´ìƒ ì„¤ì •</button>
        <button onclick="toggleModal('itemManagerMenu', true)" style="flex:1; background:#2980b9; color:white; padding:10px;">ğŸ’Š ì•„ì´í…œ ì„¤ì •</button>
        <button onclick="toggleModal('itemUseMenu', true)" style="flex:1; background:var(--heal-accent); color:white; padding:10px;">ğŸ’ ì•„ì´í…œ ì‚¬ìš©</button>
    </div>

    <div style="display:flex; gap:8px;">
        <button class="admin-control" onclick="exportData()" style="background:#27ae60; color:white; padding:8px 15px;">ğŸ“¤ ì €ì¥</button>
        <button class="admin-control" onclick="document.getElementById('fileInput').click()" style="background:#2980b9; color:white; padding:8px 15px;">ğŸ“¥ ë¡œë“œ</button>
        <button class="admin-control" onclick="resetAllData()" style="background:#e63946; color:white; padding:8px 15px;">ğŸ§¹ ì „ì²´ ë¦¬ì…‹</button>
        <button onclick="toggleModal('skillMemoMenu', true)" style="flex:1; background:var(--skill-accent); color:white; padding:8px;">ğŸ“œ ìŠ¤í‚¬ ë©”ëª¨</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(event)">
    </div>

    <div class="log-area" id="logArea"></div>
</div>

<div class="side-panel">
    <div style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:var(--enemy-accent);">ENEMIES</h3>
        <button class="admin-control" onclick="createUnit('enemy'); broadcastData();" style="background:var(--enemy-accent); color:white; width:30px; height:30px; border-radius:50%;">+</button>
    </div>
    <div id="enemyList" class="char-scroll-area"></div>
</div>

<script>
    const socket = io();
    const MASTER_PW = "qazplm10110925";
    let isMaster = false; let unitIdx = 0; let round = 1; let statusTypes = []; let itemTypes = []; let skillData = [];
    let selections = { atkSrc:"", atkTar:[], healSrc:"", healTar:[], itemUseSrc:"", itemUseTar:[], itemUseSel:"", skillOwner:"" };

    function askMasterPassword() { const pw = prompt("ë¹„ë°€ë²ˆí˜¸:"); if (pw === MASTER_PW) { isMaster = true; document.body.classList.remove('is-viewer'); document.getElementById('masterBadge').textContent = "ğŸ‘‘ ë§ˆìŠ¤í„° ê¶Œí•œ"; document.getElementById('masterBadge').style.background = "var(--turn-active)"; alert("ì¸ì¦ ì„±ê³µ"); } }
    
    function createUnit(t, s = null) {
        unitIdx++; const id = unitIdx; const c = document.getElementById(t === 'player' ? 'playerList' : 'enemyList');
        const div = document.createElement('div'); div.className = 'char-card'; div.id = `unitCard_${id}`;
        if(s?.isKO) div.classList.add('is-ko');
        const ro = isMaster ? "" : "readonly";
        div.innerHTML = `
            <div class="ko-badge">ì „íˆ¬ ë¶ˆëŠ¥</div>
            <div class="card-header" onclick="toggleCard(${id})">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <input type="text" class="init-input" value="${s?.init || '1'}" onchange="broadcastData()" onclick="event.stopPropagation()" ${ro}>
                    <input type="text" class="name-input" value="${s?.name || (t==='player'?'Player':'Enemy')+id}" onchange="refreshDropdowns(); broadcastData();" onclick="event.stopPropagation()" style="border:none; font-weight:800; width:100px;" ${ro}>
                    <span id="hpBadge_${id}" style="font-size:11px; font-weight:bold;">100/100</span>
                </div>
                <div class="hp-bar-outer"><div class="hp-bar-inner" id="hpBar_${id}" style="background:var(--heal-accent)"></div></div>
            </div>
            <div class="card-body" id="cardBody_${id}">
                <div class="stat-grid">
                    ${['atk','hit','eva','critR','critD','hp','max'].map(st => `
                        <div class="stat-item"><label>${st.toUpperCase()}</label><input type="number" class="${st}" value="${s ? s.stats[st] : (st==='hit'?100:st==='max'?100:st==='hp'?100:st==='critD'?150:10)}" oninput="updateHP(${id})" ${ro}></div>
                    `).join('')}
                </div>
                <button class="admin-control" onclick="finishUnitTurn(${id})" style="width:100%; background:var(--turn-active); padding:8px; margin-top:10px; font-size:11px;">í–‰ë™ ì™„ë£Œ (ê²°ì‚°)</button>
                <div style="margin-top:10px; border-top:1px dashed #eee; padding-top:8px;">
                    <button class="admin-control" onclick="openUnitStatusSelect(event, ${id})" style="width:100%; font-size:10px; background:#f8f9fa; border:1px solid #ddd; padding:4px;">+ ìƒíƒœì´ìƒ ë¶€ì—¬</button>
                    <div id="unitActiveStatus_${id}" style="margin-top:5px;"></div>
                    <div id="unitStatusMenu_${id}" class="dropdown-menu"></div>
                </div>
            </div>`;
        c.appendChild(div);
        if(s?.activeStatus) s.activeStatus.forEach(st => addStatusBadge(id, st));
        updateHP(id, false); refreshDropdowns();
    }

    // [ì ê²€ 4, 5ë²ˆ] í–‰ë™ ì¢…ë£Œ í›„ ê°œë³„ ê²°ì‚° ë° í–‰ë™ë¶ˆê°€ ì²´í¬
    function finishUnitTurn(id) {
        const c = document.getElementById(`unitCard_${id}`);
        const name = c.querySelector('.name-input').value;
        const statusArea = document.getElementById(`unitActiveStatus_${id}`);
        
        statusArea.querySelectorAll('.status-badge').forEach(badge => {
            const type = badge.dataset.stat;
            const power = parseFloat(badge.dataset.power);
            let remain = parseInt(badge.dataset.remain);

            if(type === 'dot') {
                const dmg = Math.ceil(parseFloat(c.querySelector('.max').value) * (power/100));
                changeHP(id, -dmg);
                log(`[DOT] ${name}ì´(ê°€) ë…/ì¶œí˜ˆë¡œ ${dmg}ì˜ í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`, 'log-atk');
            } else if(type === 'hot') {
                const heal = Math.ceil(parseFloat(c.querySelector('.max').value) * (power/100));
                changeHP(id, heal);
                log(`[HOT] ${name}ì´(ê°€) ì§€ì† íšŒë³µìœ¼ë¡œ ${heal}ì„ íšŒë³µí–ˆìŠµë‹ˆë‹¤.`, 'log-heal');
            }

            if(remain > 0) {
                remain--; badge.dataset.remain = remain;
                badge.querySelector('.turn-label').textContent = remain === 0 ? "ë§Œë£Œ" : `${remain}T`;
                if(remain === 0) {
                    log(`[í•´ì œ] ${name}ì˜ ${badge.dataset.name} íš¨ê³¼ê°€ ëë‚¬ìŠµë‹ˆë‹¤.`);
                    badge.remove();
                }
            }
        });

        c.classList.remove('active-turn');
        c.classList.add('turn-ended');
        broadcastData();
    }

    function startFirstTurn() {
        const cards = Array.from(document.querySelectorAll('.char-card')).filter(c => !c.classList.contains('is-ko'));
        cards.sort((a,b) => parseInt(b.querySelector('.init-input').value) - parseInt(a.querySelector('.init-input').value));
        document.querySelectorAll('.char-card').forEach(c => c.classList.remove('active-turn', 'turn-ended'));
        if(cards.length > 0) {
            const first = cards[0]; const id = first.id.split('_')[1];
            first.classList.add('active-turn');
            const skip = first.querySelector('.status-badge[data-stat="skip"]');
            if(skip) {
                log(`[í–‰ë™ë¶ˆê°€] ${first.querySelector('.name-input').value}ì€(ëŠ”) ì›€ì§ì¼ ìˆ˜ ì—†ì–´ í„´ì´ ë„˜ì–´ê°‘ë‹ˆë‹¤.`, 'log-atk');
                setTimeout(() => finishUnitTurn(id), 800);
            }
        }
        broadcastData();
    }

    // [ì ê²€ 1, 6, 13ë²ˆ] ë©”ì¸ ì „íˆ¬ ë° íŠ¹ìˆ˜ ìŠ¤í¬ë¦½íŠ¸
    function executeAction(type) {
        if(type === 'attack') {
            const src = findCardByName(selections.atkSrc); if(!src || selections.atkTar.length === 0) return;
            const atk = parseFloat(src.querySelector('.atk').value), hit = parseFloat(src.querySelector('.hit').value);
            const critR = parseFloat(src.querySelector('.critR').value), critD = parseFloat(src.querySelector('.critD').value);

            selections.atkTar.forEach(tarName => {
                const tarC = findCardByName(tarName); if(!tarC) return;
                const eva = parseFloat(tarC.querySelector('.eva').value);
                if(Math.random()*100 <= (hit - eva)) {
                    const isCrit = Math.random()*100 <= critR;
                    const dmg = isCrit ? Math.ceil(atk * (critD/100)) : atk;
                    changeHP(tarC.id.split('_')[1], -dmg);
                    if(isCrit) log(`ğŸ’¥ <b>CRITICAL!</b> ${selections.atkSrc} â†’ ${tarName}: ${dmg} í”¼í•´!`, 'log-crit');
                    else log(`âš”ï¸ ${selections.atkSrc} â†’ ${tarName}: ${dmg} í”¼í•´`, 'log-atk');
                } else log(`ğŸ’¨ ${selections.atkSrc}ì˜ ê³µê²©ì„ ${tarName}ì´(ê°€) íšŒí”¼í–ˆìŠµë‹ˆë‹¤.`);
            });
        } else if(type === 'heal') {
            const power = parseFloat(findCardByName(selections.healSrc)?.querySelector('.atk').value || 10);
            selections.healTar.forEach(tarName => {
                const tC = findCardByName(tarName); if(!tC) return;
                changeHP(tC.id.split('_')[1], power);
                log(`âœ¨ ${selections.healSrc} â†’ ${tarName}: ${power} íšŒë³µ`, 'log-heal');
            });
        }
        broadcastData();
    }

    function changeHP(id, val) {
        const c = document.getElementById(`unitCard_${id}`); const hpIn = c.querySelector('.hp');
        const max = parseFloat(c.querySelector('.max').value);
        let nh = Math.min(max, parseFloat(hpIn.value) + val);
        hpIn.value = nh.toFixed(1); updateHP(id);
        if(nh <= 0) log(`ğŸ’€ <b>[ì‚¬ë§]</b> ${c.querySelector('.name-input').value}ì´(ê°€) ì „íˆ¬ ë¶ˆëŠ¥ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'log-death');
    }

    // [ì ê²€ 8, 11, 12ë²ˆ] ì•„ì´í…œ ì‹¤í–‰ ë° ìŠ¤í‚¬ ë©”ëª¨ ë³µêµ¬
    function executeItemUse() {
        if(!selections.itemUseSel || selections.itemUseTar.length === 0) return;
        const item = itemTypes.find(i => i.name === selections.itemUseSel);
        selections.itemUseTar.forEach(tName => {
            const tC = findCardByName(tName); if(!tC) return;
            changeHP(tC.id.split('_')[1], parseFloat(item.power));
            log(`ğŸ’ ${selections.itemUseSrc || 'ëˆ„êµ°ê°€'} â†’ ${tName}: [${item.name}] ì‚¬ìš©! (+${item.power})`, 'log-heal');
        });
        toggleModal('itemUseMenu', false); broadcastData();
    }

    function addNewSkill() {
        const owner = selections.skillOwner, name = document.getElementById('skName').value;
        const desc = document.getElementById('skDesc').value, type = document.getElementById('skType').value;
        if(!owner || !name) return alert("ëŒ€ìƒê³¼ ìŠ¤í‚¬ëª…ì„ í™•ì¸í•˜ì„¸ìš”.");
        skillData.push({ owner, name, desc, type });
        renderSkillList(); document.getElementById('skName').value = ""; document.getElementById('skDesc').value = "";
        broadcastData();
    }

    function renderSkillList() {
        const area = document.getElementById('skillListArea');
        const grouped = skillData.reduce((acc, s) => { if(!acc[s.owner]) acc[s.owner] = []; acc[s.owner].push(s); return acc; }, {});
        area.innerHTML = Object.keys(grouped).map(owner => `
            <div class="skill-group"><div class="skill-group-header">ğŸ‘¤ ${owner}</div>
            ${grouped[owner].map((s, idx) => `<div style="padding:8px; border-bottom:1px solid #f9f9f9; font-size:11px;">
                <b>[${s.type}] ${s.name}</b><br>${s.desc} <button onclick="deleteSkill('${owner}', ${idx})" style="float:right; color:red; background:none;">Ã—</button>
            </div>`).join('')}</div>`).join('');
    }
    function deleteSkill(owner, idx) { 
        const realIdx = skillData.findIndex(s => s.owner === owner && skillData.filter(x => x.owner === owner).indexOf(s) === idx);
        skillData.splice(realIdx, 1); renderSkillList(); broadcastData(); 
    }

    // [ì‹œìŠ¤í…œ ìœ í‹¸]
    function updateHP(id, b = true) {
        const c = document.getElementById(`unitCard_${id}`); const hp = parseFloat(c.querySelector('.hp').value), max = parseFloat(c.querySelector('.max').value);
        const p = Math.max(0, Math.min(100, (hp/max)*100));
        document.getElementById(`hpBadge_${id}`).textContent = `${Math.ceil(hp)}/${Math.ceil(max)}`;
        document.getElementById(`hpBar_${id}`).style.width = p+"%";
        if(hp <= 0) c.classList.add('is-ko'); else c.classList.remove('is-ko');
        if(b) broadcastData();
    }

    function refreshDropdowns() {
        const names = Array.from(document.querySelectorAll('.name-input')).map(i => i.value);
        const lists = { atkSrcList: names, atkTarList: names, healSrcList: names, healTarList: names, itemUseSrcList: names, itemUseTarList: names, itemUseSelList: itemTypes.map(i => i.name), skillOwnerList: ["ê³µí†µ", ...names] };
        Object.keys(lists).forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = lists[id].map(n => `<div onclick="selectTarget('${id}', '${n}')">${n}</div>`).join(""); });
    }

    function selectTarget(listId, name) {
        if(listId.includes('Tar')) {
            const m = listId.split('Tar')[0]; if(!selections[m+'Tar'].includes(name)) selections[m+'Tar'].push(name);
            renderTags(m);
        } else {
            const key = listId.replace('List', ''); selections[key] = name;
            document.getElementById(listId.replace('List', 'Btn')).textContent = name;
        }
        closeMenus();
    }
    function renderTags(m) { document.getElementById(m+'TarTags').innerHTML = selections[m+'Tar'].map(n => `<span class="target-tag">${n}<b onclick="removeTag('${m}', '${n}')">Ã—</b></span>`).join(""); }
    function removeTag(m, n) { selections[m+'Tar'] = selections[m+'Tar'].filter(x => x !== n); renderTags(m); }

    function toggleCard(id, f) { const b = document.getElementById(`cardBody_${id}`); if(f !== undefined ? f : !b.classList.contains('expanded')) b.classList.add('expanded'); else b.classList.remove('expanded'); }
    function openSelect(e, id) { e.stopPropagation(); closeMenus(); document.getElementById(id).style.display = 'block'; }
    function closeMenus() { document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none'); }
    function toggleModal(id, sh) { document.getElementById(id).style.display = sh?'block':'none'; document.getElementById('overlay').style.display = sh?'block':'none'; if(sh) refreshDropdowns(); }
    function closeAllModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); document.getElementById('overlay').style.display = 'none'; }
    function findCardByName(n) { return Array.from(document.querySelectorAll('.name-input')).find(i => i.value === n)?.closest('.char-card'); }
    function log(m, t='') { const a = document.getElementById('logArea'); const d = document.createElement('div'); d.className=`log-line ${t}`; d.innerHTML=m; a.prepend(d); }

    // [ê¸°íƒ€ ì„¤ì •]
    function addNewStatusType() {
        const n = document.getElementById('msName').value, s = document.getElementById('msStat').value, p = document.getElementById('msPower').value, t = document.getElementById('msTurn').value;
        if(!n || !p) return; statusTypes.push({ name:n, stat:s, power:p, turn:parseInt(t) }); renderStatusTypeList(); broadcastData();
    }
    function renderStatusTypeList() { document.getElementById('statusTypeList').innerHTML = statusTypes.map((s, i) => `<div style="font-size:11px;">${s.name} (${s.stat}) <button onclick="statusTypes.splice(${i},1); renderStatusTypeList();">Ã—</button></div>`).join(""); }
    function addNewItemType() {
        const n = document.getElementById('itemName').value, p = document.getElementById('itemPower').value;
        if(!n || !p) return; itemTypes.push({ name:n, power:p }); renderItemTypeList(); broadcastData();
    }
    function renderItemTypeList() { document.getElementById('itemTypeList').innerHTML = itemTypes.map((it, i) => `<div style="font-size:11px;">${it.name} (+${it.power}) <button onclick="itemTypes.splice(${i},1); renderItemTypeList();">Ã—</button></div>`).join(""); }
    
    function openUnitStatusSelect(e, id) { e.stopPropagation(); const m = document.getElementById(`unitStatusMenu_${id}`); m.innerHTML = statusTypes.map(s => `<div onclick="applyStatus(${id}, '${s.name}')">${s.name}</div>`).join(""); m.style.display='block'; }
    function applyStatus(id, name) {
        const st = statusTypes.find(s => s.name === name); addStatusBadge(id, { ...st, remainTurn: st.turn });
        log(`[ìƒíƒœ] ${document.getElementById(`unitCard_${id}`).querySelector('.name-input').value} â† ${name}`); closeMenus(); broadcastData();
    }
    function addStatusBadge(id, st) {
        const area = document.getElementById(`unitActiveStatus_${id}`); const div = document.createElement('div');
        div.className = `status-badge ${st.stat}`; div.dataset.stat = st.stat; div.dataset.power = st.power; div.dataset.remain = st.remainTurn; div.dataset.name = st.name;
        div.innerHTML = `<span>${st.name} <small class="turn-label">${st.remainTurn==0?'âˆ':st.remainTurn+'T'}</small></span><b onclick="this.parentNode.remove(); broadcastData();" style="cursor:pointer;">Ã—</b>`;
        area.appendChild(div);
    }

    function resetAllData() { if(confirm("ì™„ì „ ì´ˆê¸°í™”í• ê¹Œìš”?")) location.reload(); }
    function processRoundEnd() { round++; document.getElementById('roundNum').textContent = round; log(`â”â” ROUND ${round} START â”â”`, 'log-round'); broadcastData(); }
    
    function exportData() {
        const data = { round, statusTypes, itemTypes, skillData, units: Array.from(document.querySelectorAll('.char-card')).map(c => ({
            type: c.closest('.side-panel').querySelector('h3').textContent.toLowerCase(), name: c.querySelector('.name-input').value, init: c.querySelector('.init-input').value,
            stats: Array.from(c.querySelectorAll('.stat-grid input')).reduce((acc, i) => ({...acc, [i.className]: i.value}), {}),
            activeStatus: Array.from(c.querySelectorAll('.status-badge')).map(b => ({ name: b.dataset.name, stat: b.dataset.stat, power: b.dataset.power, remainTurn: b.dataset.remain })), isKO: c.classList.contains('is-ko')
        }))};
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type:'application/json'})); a.download='battle_data.json'; a.click();
    }
    function importData(e) {
        const reader = new FileReader(); reader.onload = (re) => {
            const d = JSON.parse(re.target.result); document.getElementById('playerList').innerHTML=''; document.getElementById('enemyList').innerHTML='';
            round=d.round; statusTypes=d.statusTypes; itemTypes=d.itemTypes; skillData=d.skillData||[];
            d.units.forEach(u => createUnit(u.type.includes('player')?'player':'enemy', u));
            document.getElementById('roundNum').textContent=round; renderStatusTypeList(); renderItemTypeList(); renderSkillList(); broadcastData();
        }; reader.readAsText(e.target.files[0]);
    }
    function rollDice() {
        const spec = document.getElementById('diceType').value || "1d100"; const succ = parseInt(document.getElementById('diceSuccess').value);
        const [c, s] = spec.split('d').map(Number); let tot = 0; for(let i=0; i<c; i++) tot += Math.floor(Math.random()*s)+1;
        let res = `ğŸ² ë‹¤ì´ìŠ¤ [${spec}]: <b>${tot}</b>`; if(!isNaN(succ)) res += tot <= succ ? " <span style='color:blue'>(ì„±ê³µ)</span>" : " <span style='color:red'>(ì‹¤íŒ¨)</span>";
        log(res, 'log-dice'); broadcastData();
    }

    function broadcastData() { if(isMaster) socket.emit('battleUpdate', { round, statusTypes, itemTypes, skillData, htmlP: document.getElementById('playerList').innerHTML, htmlE: document.getElementById('enemyList').innerHTML, log: document.getElementById('logArea').innerHTML }); }
    socket.on('battleUpdate', (d) => { if(!isMaster) { round=d.round; statusTypes=d.statusTypes; itemTypes=d.itemTypes; skillData=d.skillData; document.getElementById('playerList').innerHTML=d.htmlP; document.getElementById('enemyList').innerHTML=d.htmlE; document.getElementById('logArea').innerHTML=d.log; document.getElementById('roundNum').textContent=round; renderSkillList(); } });
</script>
</body>
</html>
