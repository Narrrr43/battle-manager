<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Battle Manager v6.91</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg-color: #f0f2f5; --side-bg: #ffffff; --player-accent: #4361ee; --enemy-accent: #e63946; --heal-accent: #2a9d8f; --dice-accent: #8e44ad; --turn-active: #00d2ff; --text-main: #2d3436; --border: #dfe6e9; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Pretendard', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .side-panel { width: 350px; display: flex; flex-direction: column; background: var(--side-bg); border: 1px solid var(--border); }
        .char-scroll-area { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; }
        .center-panel { flex: 1; display: flex; flex-direction: column; padding: 12px; gap: 10px; overflow: hidden; }
        .char-card { background: #fff; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; transition: all 0.3s ease; }
        .char-card.active-turn { border: 3px solid var(--turn-active); box-shadow: 0 0 15px rgba(0, 210, 255, 0.5); transform: scale(1.02); z-index: 5; }
        .char-card.turn-ended { opacity: 0.5; background: #f8f9fa; }
        .char-card.is-ko { filter: grayscale(1); opacity: 0.5; pointer-events: none; }
        .ko-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); background: rgba(0,0,0,0.8); color: white; padding: 5px 15px; border: 2px solid red; font-weight: 900; z-index: 100; display: none; }
        .char-card.is-ko .ko-badge { display: block; }
        .card-header { padding: 12px; cursor: pointer; background: #fff; display: flex; flex-direction: column; border-radius: 12px; }
        .card-body { overflow: hidden; max-height: 0; transition: max-height 0.4s ease; padding: 0 12px; background: #fff; opacity: 0; visibility: hidden; }
        .card-body.expanded { max-height: 2000px; padding: 12px; border-top: 1px solid #f1f1f1; opacity: 1; visibility: visible; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 12px; }
        .stat-item { display: flex; align-items: center; justify-content: space-between; font-size: 11px; }
        .stat-item input { width: 42px; border: none; border-bottom: 1px solid #ddd; text-align: right; font-weight: 600; background: transparent; }
        .init-input { width: 60px !important; color: var(--turn-active); border-bottom: 2px solid var(--turn-active) !important; font-weight: 900 !important; text-align: center; font-size: 12px; }
        .hp-bar-outer { width: 100%; height: 4px; background: #eee; border-radius: 8px; margin-top: 5px; }
        .hp-bar-inner { height: 100%; width: 100%; transition: 0.3s; }
        .arrow-icon { font-size: 10px; transition: transform 0.3s; color: #b2bec3; }
        .turn-display { background: #2d3436; color: white; padding: 8px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .log-area { flex: 1; background: #fff; border-radius: 10px; padding: 10px; overflow-y: auto; border: 2px solid var(--border); font-size: 13px; line-height: 1.6; }
        .log-line { margin-bottom: 4px; padding: 2px 5px; border-radius: 4px; border-left: 3px solid transparent; }
        .log-round-box { background: #2d3436; color: #fff; padding: 8px; margin: 15px 0; border-radius: 6px; text-align: center; font-weight: 800; }
        .log-atk { border-left-color: var(--enemy-accent); }
        .log-heal { border-left-color: var(--heal-accent); }
        .log-dice { border-left-color: var(--dice-accent); background: #fbf9ff; }
        .control-row { display: flex; gap: 8px; flex-shrink: 0; height: 180px; }
        .control-box { flex: 1; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; min-width: 0; position: relative; }
        .custom-select { width: 100%; padding: 6px; border: 1px solid #eee; border-radius: 5px; margin-bottom: 4px; font-size: 11px; cursor: pointer; background: #f9f9f9; overflow: hidden; white-space: nowrap; }
        .dropdown-menu { display: none; position: absolute; background: #fff; width: 140px; z-index: 500; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; }
        .dropdown-menu div { padding: 6px; cursor: pointer; font-size: 11px; border-bottom: 1px solid #eee; }
        .target-tag { display: inline-flex; align-items: center; background: #edf2f7; padding: 2px 6px; margin: 1px; border-radius: 4px; font-size: 10px; }
        .target-tag b { margin-left: 4px; color: #e63946; cursor: pointer; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 380px; background: white; z-index: 1000; border-radius: 12px; padding: 18px; display: none; box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index: 999; display: none; }
        button { cursor: pointer; border: none; font-weight: 700; border-radius: 5px; transition: 0.15s; }
        .btn-action { width: 100%; padding: 8px; color: white; margin-top: auto; font-size: 11px; }
        .status-badge { display: flex; justify-content: space-between; align-items: center; background: #f1f2f6; padding: 2px 6px; border-radius: 4px; margin-bottom: 2px; font-size: 10px; }
        .status-badge input { width: 28px; text-align: center; border: 1px solid #ccc; border-radius: 3px; font-size: 10px; }
        .is-viewer .admin-control { pointer-events: none; opacity: 0.7; }
        #masterBadge { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 2000; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .admin-only { background: var(--turn-active); color: #000; }
        .viewer-only { background: #636e72; color: #fff; }
    </style>
</head>
<body onclick="closeMenus()" class="is-viewer">

<div id="masterBadge" class="viewer-only" onclick="askMasterPassword()">ğŸ‘€ ê´€ì „ì ëª¨ë“œ (ì¸ì¦í•˜ë ¤ë©´ í´ë¦­)</div>
<div class="overlay" id="overlay"></div>

<div id="statusManagerMenu" class="modal">
    <h4 style="margin:0 0 10px 0;">âœ¨ ìƒíƒœì´ìƒ & DOT/HOT ë“±ë¡</h4>
    <div style="display:flex; flex-direction:column; gap:6px;">
        <input type="text" id="msName" placeholder="íš¨ê³¼ ì´ë¦„" style="padding:8px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
        <div style="display:flex; gap:4px;">
            <select id="msStat" style="flex:1.2; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
                <option value="atk">ê³µê²©ë ¥ %</option><option value="int">ì§€ëŠ¥ %</option><option value="hit">ëª…ì¤‘ë¥  %</option><option value="eva">íšŒí”¼ìœ¨ %</option><option value="critR">ì¹˜ëª…íƒ€ í™•ë¥  %</option><option value="critD">ì¹˜ëª…íƒ€ ë°ë¯¸ì§€ %</option><option value="dot">ì§€ì†í”¼í•´(MAX HP %)</option><option value="hot">ì§€ì†íšŒë³µ(MAX HP %)</option><option value="skip">â›” í–‰ë™ ë¶ˆê°€</option>
            </select>
            <input type="number" id="msPower" placeholder="ìˆ˜ì¹˜" style="flex:0.8; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
        </div>
        <input type="number" id="msTurn" placeholder="ì§€ì† í„´" style="padding:8px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
        <button onclick="addNewStatusType()" style="background:var(--player-accent); color:white; padding:10px; font-size:12px;">ë“±ë¡</button>
    </div>
    <div id="statusTypeList" style="margin-top:12px; max-height:150px; overflow-y:auto; border-top:1px solid #eee;"></div>
    <button onclick="toggleModal('statusManagerMenu', false)" style="width:100%; margin-top:8px; padding:8px; background:#eee; font-size:11px;">ë‹«ê¸°</button>
</div>

<div id="itemManagerMenu" class="modal">
    <h4 style="margin:0 0 10px 0;">ğŸ’Š ì•„ì´í…œ ë“±ë¡</h4>
    <div style="display:flex; flex-direction:column; gap:6px;">
        <input type="text" id="itemName" placeholder="ì•„ì´í…œ ì´ë¦„" style="padding:8px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
        <input type="number" id="itemPower" placeholder="íšŒë³µëŸ‰" style="padding:8px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
        <button onclick="addNewItemType()" style="background:var(--heal-accent); color:white; padding:10px; font-size:12px;">ë“±ë¡</button>
    </div>
    <div id="itemTypeList" style="margin-top:12px; max-height:100px; overflow-y:auto; border-top:1px solid #eee;"></div>
    <button onclick="toggleModal('itemManagerMenu', false)" style="width:100%; margin-top:8px; padding:8px; background:#eee; font-size:11px;">ë‹«ê¸°</button>
</div>

<div id="useItemPopup" class="modal">
    <h4 style="margin:0 0 10px 0;">ğŸ‘œ ì•„ì´í…œ ì‚¬ìš©</h4>
    <div style="display:flex; flex-direction:column; gap:8px;">
        <div class="custom-select" onclick="openSelect(event, 'itemSelList')" id="itemSelBtn">ì•„ì´í…œ ì„ íƒ</div>
        <div id="itemSelList" class="dropdown-menu"></div>
        <div class="custom-select" onclick="openSelect(event, 'itemUserList')" id="itemUserBtn">ëŒ€ìƒì</div>
        <div id="itemUserList" class="dropdown-menu"></div>
        <button onclick="useItemNow()" style="background:var(--heal-accent); color:white; padding:12px; font-size:13px;">ì¦‰ì‹œ ì‚¬ìš©</button>
    </div>
    <button onclick="toggleModal('useItemPopup', false)" style="width:100%; margin-top:12px; padding:8px; background:#eee; font-size:11px;">ì·¨ì†Œ</button>
</div>

<div class="side-panel">
    <div class="panel-header" style="padding:10px; display:flex; justify-content:space-between; align-items:center;">
        <h5 style="margin:0; color:var(--player-accent);">PLAYERS</h5>
        <button class="admin-control" onclick="createUnit('player'); broadcastData();" style="background:var(--player-accent); color:white; padding:2px 8px;">+</button>
    </div>
    <div id="playerList" class="char-scroll-area"></div>
</div>

<div class="center-panel">
    <div class="turn-display">
        <div style="display:flex; align-items:center; gap:10px;">
            <b>ROUND <span id="roundNum">1</span></b>
            <button class="admin-control" onclick="startFirstTurn()" style="background:var(--turn-active); color:#2d3436; padding:4px 10px; font-size:11px;">ì „íˆ¬ ì‹œì‘</button>
        </div>
        <button class="admin-control" onclick="processEndPhase()" style="background:var(--enemy-accent); color:white; padding:4px 12px; font-size:11px;">ë¼ìš´ë“œ ê²°ì‚° & ì¢…ë£Œ</button>
    </div>

    <div class="control-row admin-control">
        <div class="control-box">
            <h6 style="margin:0 0 6px 0; color:var(--enemy-accent);">âš”ï¸ ATTACK</h6>
            <div class="custom-select" onclick="openSelect(event, 'atkSrcList')" id="atkSrcBtn">ê³µê²©ì</div>
            <div id="atkSrcList" class="dropdown-menu"></div>
            <div class="custom-select" onclick="openSelect(event, 'atkTarList')" id="atkTarBtn">ëŒ€ìƒ ì¶”ê°€</div>
            <div id="atkTarList" class="dropdown-menu"></div>
            <div id="atkTarTags" style="font-size:10px; min-height:15px;"></div>
            <button class="btn-action" style="background:#2d3436;" onclick="executeAction('attack')">BASIC ATTACK</button>
        </div>
        <div class="control-box" style="background: #fbf9ff; border: 2px dashed var(--dice-accent);">
            <h6 style="margin:0 0 6px 0; color:var(--dice-accent);">ğŸ² DICE</h6>
            <input type="text" id="diceType" placeholder="1d100" style="width:100%; text-align:center; margin-bottom:4px; padding:4px; border:1px solid #ddd; border-radius:4px;">
            <input type="number" id="diceSuccess" placeholder="ì„±ê³µê°’" style="width:100%; text-align:center; margin-bottom:4px; padding:4px; border:1px solid #ddd; border-radius:4px;">
            <button class="btn-action" style="background:var(--dice-accent);" onclick="rollDice()">ROLL</button>
        </div>
        <div class="control-box">
            <h6 style="margin:0 0 6px 0; color:var(--heal-accent);">â¤ï¸ HEAL</h6>
            <div class="custom-select" onclick="openSelect(event, 'healSrcList')" id="healSrcBtn">ì¹˜ë£Œì</div>
            <div id="healSrcList" class="dropdown-menu"></div>
            <div class="custom-select" onclick="openSelect(event, 'healTarList')" id="healTarBtn">ëŒ€ìƒ ì¶”ê°€</div>
            <div id="healTarList" class="dropdown-menu"></div>
            <div id="healTarTags" style="font-size:10px; min-height:15px;"></div>
            <button class="btn-action" style="background:var(--heal-accent);" onclick="executeAction('heal')">HEAL</button>
        </div>
    </div>

    <div class="admin-control" style="display:flex; gap:5px; background:white; padding:8px; border-radius:10px; border:1px solid var(--border);">
        <button onclick="toggleModal('statusManagerMenu', true)" style="flex:1; background:#34495e; color:white; padding:8px; font-size:11px;">âš™ï¸ ìƒíƒœì´ìƒ ì„¤ì •</button>
        <button onclick="toggleModal('itemManagerMenu', true)" style="flex:1; background:#2980b9; color:white; padding:8px; font-size:11px;">ğŸ’Š ì•„ì´í…œ ì„¤ì •</button>
        <button onclick="toggleModal('useItemPopup', true)" style="flex:1.5; background:#27ae60; color:white; padding:8px; font-size:11px;">ğŸ‘œ ì•„ì´í…œ ì‚¬ìš©</button>
    </div>

    <div class="admin-control" style="display:flex; gap:5px;">
        <button onclick="exportData()" style="background:#27ae60; color:white; padding:6px 12px; font-size:11px;">ğŸ“¤ ì €ì¥</button>
        <button onclick="document.getElementById('fileInput').click()" style="background:#2980b9; color:white; padding:6px 12px; font-size:11px;">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button onclick="resetAllData()" style="background:#e63946; color:white; padding:6px 12px; font-size:11px;">ğŸ§¹ ì „ì²´ ë¦¬ì…‹</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(event)">
    </div>

    <div class="log-area" id="logArea"></div>
</div>

<div class="side-panel">
    <div class="panel-header" style="padding:10px; display:flex; justify-content:space-between; align-items:center;">
        <h5 style="margin:0; color:var(--enemy-accent);">ENEMIES</h5>
        <button class="admin-control" onclick="createUnit('enemy'); broadcastData();" style="background:var(--enemy-accent); color:white; padding:2px 8px;">+</button>
    </div>
    <div id="enemyList" class="char-scroll-area"></div>
</div>

<script>
    const socket = io();
    const MASTER_PW = "qazplm10110925";
    let isMaster = false; let unitIdx = 0; let round = 1; let statusTypes = []; let itemTypes = [];
    let selections = { atkSrc: "", atkTar: [], healSrc: "", healTar: [], itemSel: "", itemUser: "" };
    let turnList = []; let currentTurnPointer = -1;

    function askMasterPassword() { const pw = prompt("ë¹„ë°€ë²ˆí˜¸:"); if (pw === MASTER_PW) { isMaster = true; document.body.classList.remove('is-viewer'); document.getElementById('masterBadge').textContent = "ğŸ‘‘ ë§ˆìŠ¤í„° ê¶Œí•œ í™œì„±í™”"; document.getElementById('masterBadge').className = "admin-only"; document.querySelectorAll('input, select').forEach(i => i.removeAttribute('readonly')); alert("ì¸ì¦ ì„±ê³µ!"); } }
    
    function renderStatusTypeList() {
        const list = document.getElementById('statusTypeList');
        if(!list) return;
        list.innerHTML = statusTypes.map((s, idx) => `<div style="padding:4px; font-size:11px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">${s.name} (${getStatLabel(s.stat)}) <button onclick="statusTypes.splice(${idx},1); renderStatusTypeList(); broadcastData();">Ã—</button></div>`).join("");
    }
    
    function renderItemTypeList() {
        const list = document.getElementById('itemTypeList');
        if(!list) return;
        list.innerHTML = itemTypes.map((it, idx) => `<div style="padding:4px; font-size:11px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">${it.name} <button onclick="itemTypes.splice(${idx},1); renderItemTypeList(); broadcastData();">Ã—</button></div>`).join("");
    }

    function resetAllData() { if(!isMaster) return; if(confirm("ì´ˆê¸°í™”?")) { round = 1; statusTypes = []; itemTypes = []; unitIdx = 0; document.getElementById('playerList').innerHTML = ''; document.getElementById('enemyList').innerHTML = ''; document.getElementById('logArea').innerHTML = ''; document.getElementById('roundNum').textContent = "1"; renderStatusTypeList(); renderItemTypeList(); broadcastData(); } }
    
    function importData(e) {
        const f = e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = (re) => {
            try {
                const d = JSON.parse(re.target.result);
                document.getElementById('playerList').innerHTML = '';
                document.getElementById('enemyList').innerHTML = '';
                unitIdx = 0;
                round = d.round || 1;
                document.getElementById('roundNum').textContent = round;
                statusTypes = d.statusTypes || [];
                itemTypes = d.itemTypes || [];
                renderStatusTypeList();
                renderItemTypeList();
                refreshDropdowns();
                if(d.units) d.units.forEach(u => createUnit(u.type, u));
                log("ğŸ“¥ ë°ì´í„° ë¡œë“œ ì™„ë£Œ", "log-dice");
                broadcastData();
            } catch(err) {
                alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            }
        };
        reader.readAsText(f);
    }

    function exportData() {
        const data = { round, statusTypes, itemTypes, units: [] };
        document.querySelectorAll('.char-card').forEach(card => {
            const stats = {};
            card.querySelectorAll('.stat-grid input').forEach(i => { if(i.className) stats[i.className] = i.value; });
            const activeStatus = [];
            card.querySelectorAll('.status-badge').forEach(b => {
                const st = b.querySelector('.st-stack');
                activeStatus.push({ name: b.querySelector('span').textContent.split('(')[0], stat: st.dataset.stat, power: st.dataset.power, stacks: st.value, remainTurn: st.dataset.remain });
            });
            data.units.push({ type: card.closest('.side-panel').querySelector('h5').textContent.includes('PLAYERS')?'player':'enemy', name: card.querySelector('.name-input').value, init: card.querySelector('.init-input').value, stats, activeStatus, isKO: card.classList.contains('is-ko'), isActive: card.classList.contains('active-turn'), isEnded: card.classList.contains('turn-ended') });
        });
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'})); a.download = `battle_save.json`; a.click();
    }

    function createUnit(t, s = null) {
        unitIdx++; const id = unitIdx; const c = document.getElementById(t === 'player' ? 'playerList' : 'enemyList');
        const div = document.createElement('div'); div.className = 'char-card'; div.id = `unitCard_${id}`;
        if(s?.isKO) div.classList.add('is-ko'); if(s?.isActive) div.classList.add('active-turn'); if(s?.isEnded) div.classList.add('turn-ended');
        const ro = isMaster ? "" : "readonly";
        div.innerHTML = `<div class="ko-badge">ì „íˆ¬ ë¶ˆëŠ¥</div><div class="card-header" onclick="toggleCard(${id})"><div style="display:flex; justify-content:space-between; align-items:center;"><div style="display:flex; align-items:center; gap:6px;"><input type="text" class="init-input" value="${s?.init || '1'}" onchange="broadcastData()" onclick="event.stopPropagation()" ${ro}><input type="text" class="name-input" value="${s?.name || (t==='player'?'P':'E')+'-'+id}" onclick="event.stopPropagation()" onchange="refreshDropdowns(); broadcastData();" style="border:none; font-weight:800; width:65px; background:transparent; font-size:12px;" ${ro}></div><div style="display:flex; align-items:center; gap:8px;"><span id="hpBadge_${id}" style="font-size:10px; font-weight:bold;">100/100</span><span id="arrow_${id}" class="arrow-icon">â–¼</span></div></div><div class="hp-bar-outer"><div class="hp-bar-inner" id="hpBar_${id}" style="background:var(--heal-accent)"></div></div></div><div class="card-body" id="cardBody_${id}"><div class="stat-grid">${['atk','int','hit','eva','critR','critD','sp','healEff','hp','max'].map(st => `<div class="stat-item"><label>${getStatLabel(st)}</label><input type="number" class="${st}" value="${s ? s.stats[st] : getDefaultValue(st)}" oninput="updateHP(${id})" ${ro}></div>`).join('')}</div><div style="margin-top:10px; display:flex; gap:5px;"><button class="admin-control" onclick="finishCurrentTurn(${id})" style="flex:1.2; background:var(--turn-active); color:#2d3436; padding:8px; font-size:11px;">í–‰ë™ ì™„ë£Œ</button></div><div style="margin-top:8px; border-top:1px dashed #eee; padding-top:6px;"><button class="admin-control" onclick="openUnitStatusSelect(event, ${id})" style="width:100%; font-size:10px; padding:3px; background:#f8f9fa; border:1px solid #ddd;">+ ìƒíƒœì´ìƒ ë¶€ì—¬</button><div id="unitActiveStatus_${id}" style="margin-top:4px;"></div><div id="unitStatusMenu_${id}" class="dropdown-menu"></div></div></div>`;
        c.appendChild(div); if(s?.activeStatus) { const stC = div.querySelector(`#unitActiveStatus_${id}`); s.activeStatus.forEach(st => { const b = document.createElement('div'); b.className = 'status-badge'; b.innerHTML = `<span>${st.name}${st.remainTurn > 0 ? '('+st.remainTurn+'T)':''}</span><div><input type="number" value="${st.stacks}" class="st-stack" data-stat="${st.stat}" data-power="${st.power}" data-remain="${st.remainTurn}" onchange="broadcastData()"> <b onclick="if(isMaster){this.parentNode.parentNode.remove(); broadcastData();}" style="color:red; cursor:pointer;">Ã—</b></div>`; stC.appendChild(b); }); }
        updateHP(id, false); refreshDropdowns();
    }

    function executeAction(m) {
        const src = m === 'attack' ? selections.atkSrc : selections.healSrc;
        const tars = m === 'attack' ? selections.atkTar : selections.healTar;
        const sC = findCardByName(src); if(!sC || tars.length === 0) return alert("ëŒ€ìƒ í™•ì¸!");
        tars.forEach(n => {
            const tC = findCardByName(n); if(!tC) return;
            const tId = tC.id.split('_')[1];
            if(m === 'attack') {
                const sHit = getModifiedStat(sC, 'hit'), tEva = getModifiedStat(tC, 'eva');
                const hitRoll = Math.floor(Math.random() * 100) + 1;
                if(hitRoll > sHit) return log(`ğŸ’¨ ${src} â†’ ${n}: ì‹¤íŒ¨!`, 'log-dice');
                const evaRoll = Math.floor(Math.random() * 100) + 1;
                if(evaRoll <= tEva) return log(`ğŸ›¡ï¸ ${n} íšŒí”¼!`, 'log-dice');
                const sAtk = getModifiedStat(sC, 'atk'), sSp = parseFloat(sC.querySelector('.sp').value);
                const sCritR = getModifiedStat(sC, 'critR'), sCritD = getModifiedStat(sC, 'critD') / 100;
                const mastery = sHit / 10;
                let d = (sAtk * (sSp + mastery) * mastery) / 80;
                const critRoll = Math.floor(Math.random() * 100) + 1;
                let isCrit = false; if(critRoll <= sCritR) { d *= sCritD; isCrit = true; }
                d *= (0.9 + Math.random() * 0.2);
                const nextHp = Math.max(0, parseFloat(tC.querySelector('.hp').value) - d);
                tC.querySelector('.hp').value = nextHp.toFixed(1);
                log(`${isCrit ? 'ğŸ’¥ <b>CRITICAL!</b> ' : ''}âš”ï¸ ${src} â†’ ${n}: <b>${d.toFixed(1)}</b> í”¼í•´ (ìˆ™ë ¨:${mastery})`, isCrit ? 'log-atk' : '');
                if(nextHp <= 0) log(`ğŸ’€ ${n} ì‚¬ë§!`, 'log-round-box');
                updateHP(tId);
            } else {
                const intel = getModifiedStat(sC, 'int'), eff = parseFloat(sC.querySelector('.healEff').value), maxHp = parseFloat(tC.querySelector('.max').value);
                let h = ((maxHp * 0.33) / 80 * eff) + (intel * 0.2);
                h *= (0.95 + Math.random() * 0.1);
                tC.querySelector('.hp').value = Math.min(maxHp, parseFloat(tC.querySelector('.hp').value) + h).toFixed(1);
                updateHP(tId); log(`âœ¨ ${src} â†’ ${n}: <b>${h.toFixed(1)}</b> íšŒë³µ`, 'log-heal');
            }
        });
    }

    function log(m, t = '') { const a = document.getElementById('logArea'); const d = document.createElement('div'); d.className = `log-line ${t}`; d.innerHTML = m; a.prepend(d); }
    function startFirstTurn() { turnList = []; document.querySelectorAll('.char-card').forEach(c => { const id = c.id.split('_')[1], v = c.querySelector('.init-input').value; v.split(',').forEach(o => { const n = parseInt(o.trim()); if(!isNaN(n)) turnList.push({ id, order: n }); }); }); turnList.sort((a, b) => a.order - b.order); currentTurnPointer = 0; processNextTurn(); }
    function processEndPhase() { log(`â”â”â”â” ROUND ${round} ê²°ì‚° â”â”â”â”`, 'log-round-box'); document.querySelectorAll('.char-card').forEach(card => card.classList.remove('turn-ended', 'active-turn')); round++; document.getElementById('roundNum').textContent = round; currentTurnPointer = -1; broadcastData(); }
    function updateHP(id, b = true) { const c = document.getElementById(`unitCard_${id}`); if(!c) return; const hp = parseFloat(c.querySelector('.hp').value), max = parseFloat(c.querySelector('.max').value); const p = Math.max(0, Math.min(100, (hp/max)*100)); document.getElementById(`hpBadge_${id}`).textContent = `${hp.toFixed(0)}/${max.toFixed(0)}`; document.getElementById(`hpBar_${id}`).style.width = p+"%"; if(hp <= 0) c.classList.add('is-ko'); else c.classList.remove('is-ko'); if(b) broadcastData(); }
    function toggleCard(id, f) { const b = document.getElementById(`cardBody_${id}`), a = document.getElementById(`arrow_${id}`); if(!b) return; const ex = f !== undefined ? f : !b.classList.contains('expanded'); if(ex) { b.classList.add('expanded'); a.style.transform="rotate(180deg)"; } else { b.classList.remove('expanded'); a.style.transform="rotate(0deg)"; } }
    function toggleModal(id, sh) { document.getElementById(id).style.display = sh ? 'block' : 'none'; document.getElementById('overlay').style.display = sh ? 'block' : 'none'; }
    function closeMenus() { document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display='none'); }
    function openSelect(e, id) { e.stopPropagation(); closeMenus(); document.getElementById(id).style.display='block'; refreshDropdowns(); }
    function refreshDropdowns() { const names = Array.from(document.querySelectorAll('.name-input')).map(i => i.value.trim()); ['atkSrcList', 'atkTarList', 'healSrcList', 'healTarList', 'itemUserList', 'itemSelList'].forEach(id => { const list = document.getElementById(id); if(!list) return; list.innerHTML = ""; (id === 'itemSelList' ? itemTypes.map(i=>i.name) : names).forEach(n => { const d = document.createElement('div'); d.textContent = n; d.onclick = () => { const k = id.replace('List', ''); if(id.includes('Src') || id.includes('User') || id.includes('Sel')) { selections[k] = n; document.getElementById(k+'Btn').textContent = n; } else { if(!selections[k].includes(n)) selections[k].push(n); renderTags(k); } }; list.appendChild(d); }); }); }
    function renderTags(k) { document.getElementById(k+'Tags').innerHTML = selections[k].map(n => `<span class="target-tag">${n}<b onclick="selections['${k}']=selections['${k}'].filter(t=>t!=='${n}'); renderTags('${k}')">Ã—</b></span>`).join(""); }
    function findCardByName(n) { return [...document.querySelectorAll('.char-card')].find(c => c.querySelector('.name-input').value === n); }
    function getModifiedStat(c, s) { let v = parseFloat(c.querySelector('.'+s).value), m = 0; c.querySelectorAll('.st-stack').forEach(i => { if(i.dataset.stat === s) m += (parseInt(i.value) * parseFloat(i.dataset.power)); }); return v * (1 + (m/100)); }
    function rollDice() { const t = document.getElementById('diceType').value || "1d100", s = parseInt(document.getElementById('diceSuccess').value); const m = t.match(/(\d+)d(\d+)/); if(!m) return; let res = 0; for(let i=0; i<m[1]; i++) res += Math.floor(Math.random()*m[2])+1; let msg = `ğŸ² ${t}: <b>${res}</b>`; if(!isNaN(s)) msg += (res <= s) ? ` [ì„±ê³µ]` : ` [ì‹¤íŒ¨]`; log(msg, 'log-dice'); }
    function openUnitStatusSelect(e, id) { e.stopPropagation(); closeMenus(); const m = document.getElementById(`unitStatusMenu_${id}`); m.innerHTML = statusTypes.map((s, idx) => `<div onclick="applyStatus(${id}, ${idx})">${s.name}</div>`).join(""); m.style.display='block'; }
    function applyStatus(uId, sIdx) { const s = statusTypes[sIdx], targetName = document.getElementById(`unitCard_${uId}`).querySelector('.name-input').value; const b = document.createElement('div'); b.className = 'status-badge'; b.innerHTML = `<span>${s.name}${s.turn>0?'('+s.turn+'T)':''}</span><div><input type="number" value="1" class="st-stack" data-stat="${s.stat}" data-power="${s.power}" data-remain="${s.turn}" onchange="broadcastData()"> <b onclick="if(isMaster){this.parentNode.parentNode.remove(); broadcastData();}" style="color:red; cursor:pointer;">Ã—</b></div>`; document.getElementById(`unitCard_${uId}`).querySelector(`#unitActiveStatus_${uId}`).appendChild(b); log(`ğŸ”¹ ${targetName}: [${s.name}] ë¶€ì—¬`, 'log-dice'); broadcastData(); }
    function addNewStatusType() { statusTypes.push({ name: document.getElementById('msName').value, stat: document.getElementById('msStat').value, power: parseFloat(document.getElementById('msPower').value), turn: parseInt(document.getElementById('msTurn').value) }); renderStatusTypeList(); broadcastData(); }
    function addNewItemType() { itemTypes.push({ name: document.getElementById('itemName').value, power: parseFloat(document.getElementById('itemPower').value) }); renderItemTypeList(); broadcastData(); }
    function useItemNow() { const it = itemTypes.find(i=>i.name===selections.itemSel), c = findCardByName(selections.itemUser); if(!it || !c) return; c.querySelector('.hp').value = Math.min(parseFloat(c.querySelector('.max').value), parseFloat(c.querySelector('.hp').value) + it.power).toFixed(1); updateHP(c.id.split('_')[1]); log(`ğŸ’Š ${selections.itemUser} ${it.name} ì‚¬ìš©`, 'log-heal'); toggleModal('useItemPopup', false); broadcastData(); }
    function getStatLabel(s) { const l = {atk:'ê³µê²©ë ¥', int:'ì§€ëŠ¥', hit:'ëª…ì¤‘%', eva:'íšŒí”¼%', critR:'ì¹˜ëª…%', critD:'í¬ë€%', sp:'ì˜ë ¥', healEff:'ì¹˜ë£Œíš¨ìœ¨', hp:'í˜„ì¬HP', max:'ìµœëŒ€HP', dot:'ì§€ì†í”¼í•´', hot:'ì§€ì†íšŒë³µ', skip:'í–‰ë™ë¶ˆê°€'}; return l[s]; }
    function getDefaultValue(s) { const d = {atk:50, int:20, hit:80, eva:15, critR:20, critD:150, sp:5, healEff:20, hp:100, max:100}; return d[s]; }
    function broadcastData() { if (!isMaster) return; const data = { round, logHtml: document.getElementById('logArea').innerHTML, statusTypes, itemTypes, units: [] }; document.querySelectorAll('.char-card').forEach(card => { const stats = {}; card.querySelectorAll('.stat-grid input').forEach(i => { if(i.className) stats[i.className] = i.value; }); const activeStatus = []; card.querySelectorAll('.status-badge').forEach(b => { const st = b.querySelector('.st-stack'); activeStatus.push({ name: b.querySelector('span').textContent.split('(')[0], stat: st.dataset.stat, power: st.dataset.power, stacks: st.value, remainTurn: st.dataset.remain }); }); data.units.push({ type: card.closest('.side-panel').querySelector('h5').textContent.includes('PLAYERS')?'player':'enemy', name: card.querySelector('.name-input').value, init: card.querySelector('.init-input').value, stats, activeStatus, isKO: card.classList.contains('is-ko'), isActive: card.classList.contains('active-turn'), isEnded: card.classList.contains('turn-ended') }); }); socket.emit('sync_to_server', data); }
    socket.on('update_from_server', (d) => { round = d.round; document.getElementById('roundNum').textContent = round; document.getElementById('logArea').innerHTML = d.logHtml; statusTypes = d.statusTypes || []; itemTypes = d.itemTypes || []; renderStatusTypeList(); renderItemTypeList(); document.getElementById('playerList').innerHTML = ''; document.getElementById('enemyList').innerHTML = ''; d.units.forEach(u => createUnit(u.type, u)); });
    createUnit('player'); createUnit('enemy');
</script>
</body>
</html>
