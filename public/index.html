<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Battle Manager v7.00</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg-color: #f0f2f5; --side-bg: #ffffff; --player-accent: #4361ee; --enemy-accent: #e63946; --heal-accent: #2a9d8f; --dice-accent: #8e44ad; --turn-active: #00d2ff; --text-main: #2d3436; --border: #dfe6e9; --skill-accent: #6c5ce7; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Pretendard', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .side-panel { width: 350px; display: flex; flex-direction: column; background: var(--side-bg); border: 1px solid var(--border); }
        .char-scroll-area { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; }
        .center-panel { flex: 1; display: flex; flex-direction: column; padding: 12px; gap: 10px; overflow: hidden; }
        .char-card { background: #fff; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; transition: all 0.3s ease; }
        .char-card.active-turn { border: 3px solid var(--turn-active); box-shadow: 0 0 15px rgba(0, 210, 255, 0.5); transform: scale(1.02); z-index: 5; }
        .char-card.turn-ended { opacity: 0.5; background: #f8f9fa; }
        .char-card.is-ko { filter: grayscale(1); opacity: 0.5; pointer-events: none; }
        .ko-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); background: rgba(0,0,0,0.8); color: white; padding: 5px 15px; border: 2px solid red; font-weight: 900; z-index: 100; display: none; }
        .char-card.is-ko .ko-badge { display: block; }
        .card-header { padding: 12px; cursor: pointer; background: #fff; display: flex; flex-direction: column; border-radius: 12px; }
        .card-body { overflow: hidden; max-height: 0; transition: max-height 0.4s ease; padding: 0 12px; background: #fff; opacity: 0; visibility: hidden; }
        .card-body.expanded { max-height: 2000px; padding: 12px; border-top: 1px solid #f1f1f1; opacity: 1; visibility: visible; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 12px; }
        .stat-item { display: flex; align-items: center; justify-content: space-between; font-size: 11px; }
        .stat-item input { width: 42px; border: none; border-bottom: 1px solid #ddd; text-align: right; font-weight: 600; background: transparent; }
        .init-input { width: 60px !important; color: var(--turn-active); border-bottom: 2px solid var(--turn-active) !important; font-weight: 900 !important; text-align: center; font-size: 12px; }
        .hp-bar-outer { width: 100%; height: 4px; background: #eee; border-radius: 8px; margin-top: 5px; }
        .hp-bar-inner { height: 100%; width: 100%; transition: 0.3s; }
        .arrow-icon { font-size: 10px; transition: transform 0.3s; color: #b2bec3; }
        .turn-display { background: #2d3436; color: white; padding: 8px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .log-area { flex: 1; background: #fff; border-radius: 10px; padding: 10px; overflow-y: auto; border: 2px solid var(--border); font-size: 13px; line-height: 1.6; }
        .log-line { margin-bottom: 4px; padding: 2px 5px; border-radius: 4px; border-left: 3px solid transparent; }
        .log-round-box { background: #2d3436; color: #fff; padding: 8px; margin: 15px 0; border-radius: 6px; text-align: center; font-weight: 800; }
        .log-atk { border-left-color: var(--enemy-accent); }
        .log-heal { border-left-color: var(--heal-accent); }
        .log-dice { border-left-color: var(--dice-accent); background: #fbf9ff; }
        .control-row { display: flex; gap: 8px; flex-shrink: 0; height: 190px; }
        .control-box { flex: 1; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; min-width: 0; position: relative; }
        .custom-select { width: 100%; padding: 6px; border: 1px solid #eee; border-radius: 5px; margin-bottom: 4px; font-size: 11px; cursor: pointer; background: #f9f9f9; overflow: hidden; white-space: nowrap; }
        .dropdown-menu { display: none; position: absolute; background: #fff; width: 140px; z-index: 500; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; }
        .dropdown-menu div { padding: 6px; cursor: pointer; font-size: 11px; border-bottom: 1px solid #eee; }
        .target-tag { display: inline-flex; align-items: center; background: #edf2f7; padding: 2px 6px; margin: 1px; border-radius: 4px; font-size: 10px; }
        .target-tag b { margin-left: 4px; color: #e63946; cursor: pointer; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 380px; background: white; z-index: 1000; border-radius: 12px; padding: 18px; display: none; box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index: 999; display: none; }
        button { cursor: pointer; border: none; font-weight: 700; border-radius: 5px; transition: 0.15s; }
        .btn-action { width: 100%; padding: 8px; color: white; margin-top: auto; font-size: 11px; }
        .status-badge { display: flex; justify-content: space-between; align-items: center; background: #f1f2f6; padding: 2px 6px; border-radius: 4px; margin-bottom: 2px; font-size: 10px; }
        .status-badge input { width: 28px; text-align: center; border: 1px solid #ccc; border-radius: 3px; font-size: 10px; }
        .is-viewer .admin-control { pointer-events: none; opacity: 0.7; }
        #masterBadge { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 2000; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .admin-only { background: var(--turn-active); color: #000; }
        .viewer-only { background: #636e72; color: #fff; }
        
        /* ìŠ¤í‚¬ ë©”ëª¨ ì „ìš© ìŠ¤íƒ€ì¼ */
        .skill-group { margin-bottom: 10px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        .skill-group-header { background: #f8f9fa; padding: 6px 10px; font-size: 12px; font-weight: 800; border-bottom: 1px solid #eee; color: var(--skill-accent); }
    
        @keyframes logShake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-1deg); }
            50% { transform: translateX(5px) rotate(1deg); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        .shake-log { animation: logShake 0.3s ease-in-out; border-left: 5px solid #ff4757 !important; background: #fff5f5; }

        /* 1. ì¹´ë“œ í”¼ê²© í”ë“¤ë¦¼ */
        @keyframes cardShake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(-1deg); }
            40% { transform: translate(3px, 2px) rotate(1deg); }
            60% { transform: translate(-1px, -1px) rotate(1deg); }
            80% { transform: translate(-3px, 1px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(0deg); }
        }
        .shake-card { animation: cardShake 0.4s ease-in-out; }

        /* 2. ì²´ë ¥ë°” ìƒ‰ìƒ ë³€ë™ (ìš°ì„ ìˆœìœ„ ê°•í™”ë¥¼ ìœ„í•´ .hp-barë¥¼ ì•ì— ë¶™ì„) */
        .hp-bar .hp-safe { background-color: #2ecc71 !important; background: #2ecc71 !important; }    /* ë…¹ìƒ‰ */
        .hp-bar .hp-warning { background-color: #f1c40f !important; background: #f1c40f !important; } /* í™©ìƒ‰ */
        .hp-bar .hp-danger { background-color: #e74c3c !important; background: #e74c3c !important; }  /* ì ìƒ‰ */
        
        /* ì²´ë ¥ë°” ë¶€ë“œëŸ½ê²Œ ì›€ì§ì´ê²Œ ì„¤ì • */
        .hp-bar-fill { 
            transition: width 0.4s ease, background-color 0.4s ease !important; 
        }
        
        /* 3. ìƒíƒœì´ìƒ(í–‰ë™ë¶ˆëŠ¥ ë“±) ì‹œê° íš¨ê³¼ */
        .card-disabled { filter: grayscale(0.8) brightness(0.7); pointer-events: none; }
        .card-dot-effect { box-shadow: inset 0 0 15px rgba(155, 89, 182, 0.6); border: 2px solid #9b59b6 !important; }

        /* ìƒíƒœì´ìƒ ê³µí†µ íš¨ê³¼ (í…Œë‘ë¦¬ ë° ì•ˆìª½ ë°œê´‘) */
        .card-status-effect { border-width: 3px !important; transition: all 0.3s ease; }
        
        /* ê°ì „: íŒŒë€ìƒ‰ */
        .border-elec { border: 3px solid #3498db !important; box-shadow: inset 0 0 15px rgba(52, 152, 219, 0.6) !important; }
        /* í™”ìƒ/ì¶œí˜ˆ: ë¹¨ê°„ìƒ‰ */
        .border-red { border: 3px solid #e74c3c !important; box-shadow: inset 0 0 15px rgba(231, 76, 60, 0.6) !important; }
        /* ì¤‘ë…: ì´ˆë¡ìƒ‰ */
        .border-poison { border: 3px solid #2ecc71 !important; box-shadow: inset 0 0 15px rgba(46, 204, 113, 0.6) !important; }
        /* ì˜¤ì—¼: ë³´ë¼ìƒ‰ */
        .border-corrupt { border: 3px solid #9b59b6 !important; box-shadow: inset 0 0 15px rgba(155, 89, 182, 0.6) !important; }

        /* ìŠ¤í‚¬ íƒ€ì…ë³„ ì™¼ìª½ í¬ì¸íŠ¸ ë°” ìƒ‰ìƒ */
        .sk-type-ì¼ë°˜ { border-left: 5px solid #bdc3c7 !important; }      /* íšŒìƒ‰ */
        .sk-type-ê°œì—°ì£¼ìˆ  { border-left: 5px solid #3498db !important; }  /* íŒŒë‘ */
        .sk-type-ìœ ì„±ë¬¼ { border-left: 5px solid #e67e22 !important; }    /* ì£¼í™© */
        .sk-type-ìœ ì¼ìˆ ì‹ { 
            border-left: 8px solid #e74c3c !important; /* ê°•ë ¬í•œ ë¹¨ê°• */
            background-color: #fff5f5 !important;      /* ì—°í•œ ë¹¨ê°• ë°°ê²½ */
            box-shadow: inset 0 0 10px rgba(231, 76, 60, 0.1); 
        }
        /* ëª©ë¡ì— ì—†ëŠ” ê¸°íƒ€ íƒ€ì…ìš© ê¸°ë³¸ê°’ */
        .sk-type-default { border-left: 5px solid #2ecc71; }
        
    </style>
</head>
<body onclick="closeMenus()" class="is-viewer">

<div id="masterBadge" class="viewer-only" onclick="askMasterPassword()">ğŸ‘€ ê´€ì „ì ëª¨ë“œ (ì¸ì¦í•˜ë ¤ë©´ í´ë¦­)</div>
<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="statusManagerMenu" class="modal">
    <h4 style="margin:0 0 10px 0;">âœ¨ ìƒíƒœì´ìƒ & DOT/HOT ë“±ë¡</h4>
    <div style="display:flex; flex-direction:column; gap:6px;">
        <input type="text" id="msName" placeholder="íš¨ê³¼ ì´ë¦„" style="padding:8px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
        <div style="display:flex; gap:4px;">
            <select id="msStat" style="flex:1.2; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
                <option value="atk">ê³µê²©ë ¥ %</option><option value="int">ì§€ëŠ¥ %</option><option value="hit">ëª…ì¤‘ë¥  %</option><option value="eva">íšŒí”¼ìœ¨ %</option><option value="critR">ì¹˜ëª…íƒ€ í™•ë¥  %</option><option value="critD">ì¹˜ëª…íƒ€ ë°ë¯¸ì§€ %</option><option value="dot">ì§€ì†í”¼í•´(MAX HP %)</option><option value="hot">ì§€ì†íšŒë³µ(MAX HP %)</option><option value="skip">â›” í–‰ë™ ë¶ˆê°€</option><option value="noheal">ğŸš« ì¹˜ìœ  ë¶ˆê°€</option><option value="reflect">ğŸ›¡ï¸ ë°ë¯¸ì§€ ë°˜ì‚¬</option><option value="drain">ğŸ©¸ ê³µê²© ì‹œ í¡í˜ˆ</option><option value="none">âœ¨ íŠ¹ìˆ˜ íš¨ê³¼ (ë„ë°œ ë“±)</option>
            </select>
            <input type="number" id="msPower" placeholder="ìˆ˜ì¹˜" style="flex:0.8; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
        </div>
        <input type="number" id="msTurn" placeholder="ì§€ì† í„´ (0ì€ ì˜êµ¬)" style="padding:8px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
        <button onclick="addNewStatusType()" style="background:var(--player-accent); color:white; padding:10px; font-size:12px;">ë“±ë¡</button>
    </div>
    <div id="statusTypeList" style="margin-top:12px; max-height:150px; overflow-y:auto; border-top:1px solid #eee;"></div>
    <button onclick="toggleModal('statusManagerMenu', false)" style="width:100%; margin-top:8px; padding:8px; background:#eee; font-size:11px;">ë‹«ê¸°</button>
</div>

<div id="skillMemoMenu" class="modal" style="width:450px;">
    <h4 style="margin:0 0 10px 0;">ğŸ“œ ìŠ¤í‚¬ ë©”ëª¨</h4>
    <div class="admin-control" style="background:#f8f9fa; padding:12px; border-radius:10px; margin-bottom:10px;">
        <div style="display:flex; gap:5px; margin-bottom:6px;">
            <div class="custom-select" onclick="openSelect(event, 'skillOwnerList')" id="skillOwnerBtn" style="flex:1;">ì†Œìœ ì ì„ íƒ</div>
            <div id="skillOwnerList" class="dropdown-menu"></div>
            <select id="skType" style="flex:0.8; padding:6px; border-radius:5px; border:1px solid #ddd;">
                <option value="ê³ ìœ ì£¼ìˆ ">ê³ ìœ ì£¼ìˆ </option><option value="ì¼ë°˜" selected>ì¼ë°˜</option><option value="ìœ ì¼ìˆ ì‹">ìœ ì¼ìˆ ì‹</option><option value="ìœ ì„±ë¬¼">ìœ ì„±ë¬¼</option><option value="ê°œì—°ì£¼ìˆ ">ê°œì—°ì£¼ìˆ </option>
            </select>
        </div>
        <input type="text" id="skName" placeholder="ìŠ¤í‚¬ëª…" style="width:100%; padding:8px; margin-bottom:6px; box-sizing:border-box; border:1px solid #ddd; border-radius:5px;">
        <textarea id="skDesc" placeholder="ìŠ¤í‚¬ íš¨ê³¼ ì„¤ëª…" style="width:100%; height:50px; padding:8px; box-sizing:border-box; border:1px solid #ddd; border-radius:5px; font-size:12px;"></textarea>
        <button onclick="addNewSkill()" style="width:100%; background:var(--skill-accent); color:white; padding:10px; margin-top:5px;">ìŠ¤í‚¬ ë“±ë¡</button>
    </div>
    <div id="skillListArea" style="max-height:250px; overflow-y:auto;"></div>
    <button onclick="toggleModal('skillMemoMenu', false)" style="width:100%; margin-top:10px; padding:8px; background:#eee;">ë‹«ê¸°</button>
</div>

<div class="side-panel">
    <div class="panel-header" style="padding:10px; display:flex; justify-content:space-between; align-items:center;">
        <h5 style="margin:0; color:var(--player-accent);">PLAYERS</h5>
        <button class="admin-control" onclick="createUnit('player'); broadcastData();" style="background:var(--player-accent); color:white; padding:2px 8px;">+</button>
    </div>
    <div id="playerList" class="char-scroll-area"></div>
</div>

<div class="center-panel">
    <div class="turn-display">
        <div style="display:flex; align-items:center; gap:10px;">
            <b>ROUND <span id="roundNum">1</span></b>
            <button class="admin-control" onclick="startFirstTurn()" style="background:var(--turn-active); color:#2d3436; padding:4px 10px; font-size:11px;">ì „íˆ¬ ì‹œì‘</button>
        </div>
        <button class="admin-control" onclick="processEndPhase()" style="background:var(--enemy-accent); color:white; padding:4px 12px; font-size:11px;">ë¼ìš´ë“œ ê²°ì‚° & ì¢…ë£Œ</button>
    </div>

    <div class="control-row admin-control">
        <div class="control-box">
            <h6 style="margin:0 0 6px 0; color:var(--enemy-accent);">âš”ï¸ ATTACK</h6>
            <div class="custom-select" onclick="openSelect(event, 'atkSrcList')" id="atkSrcBtn">ê³µê²©ì</div>
            <div id="atkSrcList" class="dropdown-menu"></div>
            <div class="custom-select" onclick="openSelect(event, 'atkTarList')" id="atkTarBtn">ëŒ€ìƒ ì¶”ê°€</div>
            <div id="atkTarList" class="dropdown-menu"></div>
            <div id="atkTarTags" style="font-size:10px; min-height:15px; margin-bottom:2px;"></div>
            <button class="btn-action" style="background:#2d3436;" onclick="executeAction('attack')">BASIC ATTACK</button>
        </div>
        <div class="control-box" style="background: #fbf9ff; border: 2px dashed var(--dice-accent);">
            <h6 style="margin:0 0 6px 0; color:var(--dice-accent);">ğŸ² DICE</h6>
            <input type="text" id="diceType" placeholder="1d100" style="width:100%; text-align:center; margin-bottom:4px; padding:4px; border:1px solid #ddd; border-radius:4px;">
            <input type="number" id="diceSuccess" placeholder="ì„±ê³µê°’" style="width:100%; text-align:center; margin-bottom:4px; padding:4px; border:1px solid #ddd; border-radius:4px;">
            <button class="btn-action" style="background:var(--dice-accent);" onclick="rollDice()">ROLL</button>
        </div>
        <div class="control-box">
            <h6 style="margin:0 0 6px 0; color:var(--heal-accent);">â¤ï¸ HEAL</h6>
            <div class="custom-select" onclick="openSelect(event, 'healSrcList')" id="healSrcBtn">ì¹˜ë£Œì</div>
            <div id="healSrcList" class="dropdown-menu"></div>
            <div class="custom-select" onclick="openSelect(event, 'healTarList')" id="healTarBtn">ëŒ€ìƒ ì¶”ê°€</div>
            <div id="healTarList" class="dropdown-menu"></div>
            <div id="healTarTags" style="font-size:10px; min-height:15px; margin-bottom:2px;"></div>
            <button class="btn-action" style="background:var(--heal-accent);" onclick="executeAction('heal')">HEAL</button>
        </div>
    </div>

    <div class="admin-control" style="display:flex; gap:5px; background:white; padding:8px; border-radius:10px; border:1px solid var(--border);">
        <button onclick="toggleModal('statusManagerMenu', true)" style="flex:1; background:#34495e; color:white; padding:8px; font-size:11px;">âš™ï¸ ìƒíƒœì´ìƒ ì„¤ì •</button>
        <button onclick="toggleModal('itemManagerMenu', true)" style="flex:1; background:#2980b9; color:white; padding:8px; font-size:11px;">ğŸ’Š ì•„ì´í…œ ì„¤ì •</button>
        <button onclick="toggleModal('useItemPopup', true)" style="flex:1.5; background:#27ae60; color:white; padding:8px; font-size:11px;">ğŸ‘œ ì•„ì´í…œ ì‚¬ìš©</button>
    </div>

    <div style="display:flex; gap:5px;">
        <button class="admin-control" onclick="exportData()" style="background:#27ae60; color:white; padding:6px 12px; font-size:11px;">ğŸ“¤ ì €ì¥</button>
        <button class="admin-control" onclick="document.getElementById('fileInput').click()" style="background:#2980b9; color:white; padding:6px 12px; font-size:11px;">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="admin-control" onclick="resetAllData()" style="background:#e63946; color:white; padding:6px 12px; font-size:11px;">ğŸ§¹ ë¦¬ì…‹</button>
        <button onclick="toggleModal('skillMemoMenu', true)" style="flex:1.5; background:var(--skill-accent); color:white; padding:6px 12px; font-size:11px;">ğŸ“œ ìŠ¤í‚¬ ë©”ëª¨</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(event)">
    </div>

    <div class="log-area" id="logArea"></div>
</div>

<div class="side-panel">
    <div class="panel-header" style="padding:10px; display:flex; justify-content:space-between; align-items:center;">
        <h5 style="margin:0; color:var(--enemy-accent);">ENEMIES</h5>
        <button class="admin-control" onclick="createUnit('enemy'); broadcastData();" style="background:var(--enemy-accent); color:white; padding:2px 8px;">+</button>
    </div>
    <div id="enemyList" class="char-scroll-area"></div>
</div>

<div id="itemManagerMenu" class="modal">
    <h4 style="margin:0 0 10px 0;">ğŸ’Š ì•„ì´í…œ ë“±ë¡</h4>
    <div style="display:flex; flex-direction:column; gap:6px;">
        <input type="text" id="itemName" placeholder="ì•„ì´í…œ ì´ë¦„" style="padding:8px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
        <input type="number" id="itemPower" placeholder="íšŒë³µëŸ‰" style="padding:8px; border:1px solid #ddd; border-radius:6px; font-size:12px;">
        <button onclick="addNewItemType()" style="background:var(--heal-accent); color:white; padding:10px; font-size:12px;">ë“±ë¡</button>
    </div>
    <div id="itemTypeList" style="margin-top:12px; max-height:100px; overflow-y:auto; border-top:1px solid #eee;"></div>
    <button onclick="toggleModal('itemManagerMenu', false)" style="width:100%; margin-top:8px; padding:8px; background:#eee; font-size:11px;">ë‹«ê¸°</button>
</div>

<div id="useItemPopup" class="modal">
    <h4 style="margin:0 0 10px 0;">ğŸ‘œ ì•„ì´í…œ ì‚¬ìš©</h4>
    <div style="display:flex; flex-direction:column; gap:8px;">
        <div class="custom-select" onclick="openSelect(event, 'itemSelList')" id="itemSelBtn">ì•„ì´í…œ ì„ íƒ</div>
        <div id="itemSelList" class="dropdown-menu"></div>
        <div class="custom-select" onclick="openSelect(event, 'itemUserList')" id="itemUserBtn">ëŒ€ìƒì</div>
        <div id="itemUserList" class="dropdown-menu"></div>
        <button onclick="useItemNow()" style="background:var(--heal-accent); color:white; padding:12px; font-size:13px;">ì¦‰ì‹œ ì‚¬ìš©</button>
    </div>
    <button onclick="toggleModal('useItemPopup', false)" style="width:100%; margin-top:12px; padding:8px; background:#eee; font-size:11px;">ì·¨ì†Œ</button>
</div>

<script>
    const socket = io();
    const MASTER_PW = "qazplm10110925";
    let isMaster = false; let unitIdx = 0; let round = 1; let statusTypes = []; let itemTypes = []; let skillData = [];
    let selections = { atkSrc: "", atkTar: [], healSrc: "", healTar: [], itemSel: "", itemUser: "", skillOwner: "" };
    let turnList = []; let currentTurnPointer = -1;

    function askMasterPassword() { const pw = prompt("ë¹„ë°€ë²ˆí˜¸:"); if (pw === MASTER_PW) { isMaster = true; document.body.classList.remove('is-viewer'); document.getElementById('masterBadge').textContent = "ğŸ‘‘ ë§ˆìŠ¤í„° ê¶Œí•œ í™œì„±í™”"; document.getElementById('masterBadge').className = "admin-only"; alert("ì¸ì¦ ì„±ê³µ!"); broadcastData(); } }
    
    // [ìºë¦­í„° ë‚´ë¶€ ì¶”ê°€í”¼í•´ ì „ìš© ì‹¤í–‰ í•¨ìˆ˜ - ì›ë³¸ ìœ ì§€]
    function executeExtraDamage(id) {
        if(!isMaster) return;
        const card = document.getElementById(`unitCard_${id}`);
        const input = card.querySelector('.extra-dmg-input');
        const percent = parseFloat(input.value);
        if(isNaN(percent) || selections.atkTar.length === 0) return alert("í”¼í•´ % ì…ë ¥ ë° ê³µê²© ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
        const srcName = card.querySelector('.name-input').value;
        const baseAtk = getModifiedStat(card, 'atk');
        const finalDmg = baseAtk * (percent / 100);
        selections.atkTar.forEach(tarName => {
            const tC = findCardByName(tarName); if(!tC) return;
            const tId = tC.id.split('_')[1];
            const tEva = getModifiedStat(tC, 'eva');
            const evaRoll = Math.floor(Math.random() * 100) + 1;
            if(evaRoll <= tEva) { log(`ğŸ›¡ï¸ ${tarName} íšŒí”¼! (ì¶”ê°€í”¼í•´ ë¬´íš¨) [Eva:${evaRoll}/${tEva}]`, 'log-dice'); } 
            else {
                const curHp = parseFloat(tC.querySelector('.hp').value);
                tC.querySelector('.hp').value = Math.max(0, curHp - finalDmg).toFixed(1);
                log(`ğŸ’¥ ${srcName} â†’ ${tarName}: <b>${finalDmg.toFixed(1)}</b> ì¶”ê°€ í”¼í•´ (ê³µê²©ë ¥ ${percent}%)`, 'log-atk');
                updateHP(tId);
                if(parseFloat(tC.querySelector('.hp').value) <= 0) log(`ğŸ’€ ${tarName} ì‚¬ë§!`, 'log-round-box');
            }
        });
        broadcastData();
    }

    // [ìºë¦­í„° ì¹´ë“œ ìƒì„± í•¨ìˆ˜ - ì›ë³¸ ìœ ì§€]
    function createUnit(t, s = null) {
        unitIdx++; const id = unitIdx; const c = document.getElementById(t === 'player' ? 'playerList' : 'enemyList');
        const div = document.createElement('div'); div.className = 'char-card'; div.id = `unitCard_${id}`;
        if(s?.isKO) div.classList.add('is-ko'); if(s?.isActive) div.classList.add('active-turn'); if(s?.isEnded) div.classList.add('turn-ended');
        const ro = isMaster ? "" : "readonly";
        div.innerHTML = `
            <div class="ko-badge">ì „íˆ¬ ë¶ˆëŠ¥</div>
            <div class="card-header" onclick="toggleCard(${id})">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <input type="text" class="init-input" value="${s?.init || '1'}" onchange="broadcastData()" onclick="event.stopPropagation()" ${ro}>
                        <input type="text" class="name-input" value="${s?.name || (t==='player'?'P':'E')+'-'+id}" onclick="event.stopPropagation()" onchange="refreshDropdowns(); broadcastData();" style="border:none; font-weight:800; width:65px; background:transparent; font-size:12px;" ${ro}>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span id="hpBadge_${id}" style="font-size:10px; font-weight:bold;">100/100</span>
                        <span id="arrow_${id}" class="arrow-icon">â–¼</span>
                    </div>
                </div>
                <div class="hp-bar-outer"><div class="hp-bar-inner" id="hpBar_${id}" style="background:var(--heal-accent)"></div></div>
            </div>
            <div class="card-body" id="cardBody_${id}">
                <div class="stat-grid">${['atk','int','hit','eva','critR','critD','sp','healEff','hp','max'].map(st => `<div class="stat-item"><label>${getStatLabel(st)}</label><input type="number" class="${st}" value="${s ? s.stats[st] : getDefaultValue(st)}" oninput="updateHP(${id})" ${ro}></div>`).join('')}</div>
                <div class="admin-control" style="margin-top:10px; padding:8px; background:#fff5f5; border-radius:8px; border:1px solid #ffe3e3; display:flex; gap:5px; align-items:center;">
                    <input type="number" class="extra-dmg-input" placeholder="%" style="flex:1; padding:5px; font-size:11px; border:1px solid #ddd; border-radius:4px;">
                    <button onclick="executeExtraDamage(${id})" style="flex:1.5; background:var(--enemy-accent); color:white; padding:5px; font-size:11px; border-radius:4px;">ì¶”ê°€í”¼í•´</button>
                </div>
                <div style="margin-top:10px; display:flex; gap:5px;">
                    <button class="admin-control" onclick="finishCurrentTurn(${id})" style="flex:1.2; background:var(--turn-active); color:#2d3436; padding:8px; font-size:11px;">í–‰ë™ ì™„ë£Œ</button>
                </div>
                <div style="margin-top:8px; border-top:1px dashed #eee; padding-top:6px;">
                    <button class="admin-control" onclick="openUnitStatusSelect(event, ${id})" style="width:100%; font-size:10px; padding:3px; background:#f8f9fa; border:1px solid #ddd;">+ ìƒíƒœì´ìƒ ë¶€ì—¬</button>
                    <div id="unitActiveStatus_${id}" style="margin-top:4px;"></div>
                    <div id="unitStatusMenu_${id}" class="dropdown-menu"></div>
                </div>
            </div>`;
        c.appendChild(div);
        if(s?.activeStatus) {
            const stC = div.querySelector(`#unitActiveStatus_${id}`);
            s.activeStatus.forEach(st => {
                const b = document.createElement('div'); b.className = 'status-badge';
                b.innerHTML = `<span>${st.name}${st.remainTurn == 0 ? '(ì˜êµ¬)': '('+st.remainTurn+'T)'}</span><div><input type="number" value="${st.stacks}" class="st-stack" data-stat="${st.stat}" data-power="${st.power}" data-remain="${st.remainTurn}" onchange="broadcastData()"> <b onclick="if(isMaster){this.parentNode.parentNode.remove(); broadcastData();}" style="color:red; cursor:pointer;">Ã—</b></div>`;
                stC.appendChild(b);
            });
        }
        updateHP(id, false); refreshDropdowns();
    }

    // [ìƒíƒœì´ìƒ ê²°ì‚° ë¡œì§ - ì›ë³¸ ìœ ì§€]
    function finishCurrentTurn(id) {
        if(!isMaster) return;
        const card = document.getElementById(`unitCard_${id}`);
        const name = card.querySelector('.name-input').value;
        const badges = card.querySelectorAll('.status-badge');
    
        badges.forEach(badge => {
            const stInput = badge.querySelector('.st-stack');
            const type = stInput.dataset.stat, power = parseFloat(stInput.dataset.power), stacks = parseInt(stInput.value);
            let remain = parseInt(stInput.dataset.remain);
            const sName = badge.querySelector('span').textContent.split('(')[0]; // ìƒíƒœì´ìƒ ì´ë¦„ ì¶”ì¶œ
    
            // 1. ì§€ì† í”¼í•´(dot) / ì§€ì† íšŒë³µ(hot) ê³„ì‚°
            if(type === 'dot' || type === 'hot') {
                const maxHp = parseFloat(card.querySelector('.max').value), currentHp = parseFloat(card.querySelector('.hp').value);
                // ìì—°ìˆ˜ ì²˜ë¦¬ë¥¼ ìœ„í•´ Math.round ì ìš©
                const effectVal = Math.round((maxHp * (power / 100)) * stacks);
                
                if(type === 'dot') { 
                    card.querySelector('.hp').value = Math.max(0, currentHp - effectVal); 
                    log(`â˜£ï¸ ${name}: [${sName}] íš¨ê³¼ë¡œ <b>${effectVal}</b> í”¼í•´!`, 'log-atk'); 
                } else { 
                    card.querySelector('.hp').value = Math.min(maxHp, currentHp + effectVal); 
                    log(`ğŸŒ¿ ${name}: [${sName}] íš¨ê³¼ë¡œ <b>${effectVal}</b> íšŒë³µ!`, 'log-heal'); 
                }
                updateHP(id, false);
            }
    
            // 2. í„´ ê°ì†Œ ë° ë§Œë£Œ ì²˜ë¦¬
            if (remain > 0) {
                remain--;
                if (remain === 0) { 
                    log(`â³ ${name}: [${sName}] íš¨ê³¼ ì¢…ë£Œ`); 
                    badge.remove(); 
                } else { 
                    stInput.dataset.remain = remain; 
                    badge.querySelector('span').textContent = `${sName}(${remain}T)`; 
                }
            }
        });
    
        // 3. [ì¶”ê°€] ìƒíƒœì´ìƒ ì‹œê° íš¨ê³¼(í…Œë‘ë¦¬/ì–´ë‘¡ê¸°) ìµœì¢… ê°±ì‹ 
        refreshStatusEffects(card);
    
        card.classList.add('turn-ended'); 
        card.classList.remove('active-turn'); 
        processNextTurn(); 
        broadcastData();
    }

    // [í–‰ë™ê¸ˆì§€ ìŠ¤í‚µ ë¡œì§ - ì›ë³¸ ìœ ì§€]
    function processNextTurn() {
        if(currentTurnPointer < 0 || currentTurnPointer >= turnList.length) return;
        document.querySelectorAll('.char-card').forEach(c => c.classList.remove('active-turn'));
        const next = turnList[currentTurnPointer];
        const card = document.getElementById(`unitCard_${next.id}`);
        if(card) {
            if(card.classList.contains('is-ko')) { currentTurnPointer++; processNextTurn(); return; }
            let isSkipped = false;
            card.querySelectorAll('.status-badge').forEach(badge => { if(badge.querySelector('.st-stack').dataset.stat === 'skip') isSkipped = true; });
            if(isSkipped) {
                log(`â›” ${card.querySelector('.name-input').value}: í–‰ë™ ë¶ˆëŠ¥! í„´ì„ ê²°ì‚°í•˜ê³  ë„˜ê¹ë‹ˆë‹¤.`, 'log-dice');
                card.classList.add('active-turn');
                setTimeout(() => { finishCurrentTurn(next.id); }, 500);
            } else { card.classList.add('active-turn'); toggleCard(next.id, true); currentTurnPointer++; }
        } else { currentTurnPointer++; processNextTurn(); }
    }

    // ê¸°ë³¸ ì „íˆ¬ ì‹œìŠ¤í…œ, ìŠ¤í¬ë¦½íŠ¸
    function executeAction(m) {
        const src = m === 'attack' ? selections.atkSrc : selections.healSrc;
        const tars = m === 'attack' ? selections.atkTar : selections.healTar;
        const sC = findCardByName(src); if(!sC || tars.length === 0) return alert("ëŒ€ìƒ í™•ì¸!");
    
        tars.forEach(n => {
            const tC = findCardByName(n); if(!tC) return;
            const tId = tC.id.split('_')[1];
    
            if(m === 'attack') {
                const sHit = getModifiedStat(sC, 'hit'), tEva = getModifiedStat(tC, 'eva');
                const hitRoll = Math.floor(Math.random() * 100) + 1;
                if(hitRoll > sHit) return log(`ğŸ’¨ ${src} â†’ ${n}: [Hit:${hitRoll}/${sHit}] ì‹¤íŒ¨!`, 'log-dice');
                const evaRoll = Math.floor(Math.random() * 100) + 1;
                if(evaRoll <= tEva) return log(`ğŸ›¡ï¸ ${n} íšŒí”¼! [Eva:${evaRoll}/${tEva}]`, 'log-dice');
                
                const sAtk = getModifiedStat(sC, 'atk'), sSp = parseFloat(sC.querySelector('.sp').value);
                const sCritR = getModifiedStat(sC, 'critR'), sCritD = getModifiedStat(sC, 'critD') / 100;
                
                // 1. ë°ë¯¸ì§€ ê³„ì‚° (ë‚œìˆ˜ ì„ ì ìš© -> ì¹˜ëª…íƒ€ í›„ì ìš©)
                let d = ((sAtk * (sSp + (sHit/10)) * (sHit/10)) / 80);
                d *= (0.9 + Math.random() * 0.2);
                const critRoll = Math.floor(Math.random() * 100) + 1;
                let isCrit = false; 
                if(critRoll <= sCritR) { d *= sCritD; isCrit = true; }
                
                // 2. ìì—°ìˆ˜ ë³€í™˜ ë° HP ì ìš©
                const finalD = Math.round(d);
                const nextHp = Math.max(0, parseFloat(tC.querySelector('.hp').value) - finalD);
                tC.querySelector('.hp').value = nextHp;
    
                // 3. [ì¶”ê°€] í”¼ê²© ì¹´ë“œ í”ë“¤ë¦¼ íš¨ê³¼
                if(finalD > 0) {
                    tC.classList.remove('shake-card');
                    void tC.offsetWidth; // ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹
                    tC.classList.add('shake-card');
                    setTimeout(() => tC.classList.remove('shake-card'), 400);
                }
    
                // 4. ë¡œê·¸ ì¶œë ¥
                log(`${isCrit ? 'ğŸ’¥ <b>CRIT!</b> ' : ''}âš”ï¸ ${src} â†’ ${n}: <b>${finalD}</b> í”¼í•´`, isCrit ? 'log-atk shake-log' : 'log-atk');
                if(nextHp <= 0 && finalD > 0) log(`ğŸ’€ ${n} ì‚¬ë§!`, 'log-round-box');
                
                updateHP(tId);
            } else {
                // ì¹˜ë£Œ ë¡œì§
                const intel = getModifiedStat(sC, 'int'), eff = parseFloat(sC.querySelector('.healEff').value), maxHp = parseFloat(tC.querySelector('.max').value);
                let h = (((maxHp * 0.33) / 80 * eff) + (intel * 0.2));
                h *= (0.95 + Math.random() * 0.1);
                
                const finalH = Math.round(h);
                const curHp = parseFloat(tC.querySelector('.hp').value);
                tC.querySelector('.hp').value = Math.min(maxHp, curHp + finalH);
                
                updateHP(tId); 
                log(`âœ¨ ${src} â†’ ${n}: <b>${finalH}</b> íšŒë³µ`, 'log-heal');
            }
        });
        broadcastData();
    }

    function updateHP(id, b = true) {
        // 1. ìœ ë‹› ì¹´ë“œë¥¼ ì°¾ìŠµë‹ˆë‹¤ (ë‘ ê°€ì§€ ID í˜•ì‹ì„ ëª¨ë‘ ì²´í¬í•˜ë„ë¡ ì„¤ê³„)
        const c = document.getElementById(`unitCard_${id}`) || document.getElementById(`char_${id}`);
        if(!c) return;
        
        const hpInput = c.querySelector('.hp');
        const maxInput = c.querySelector('.max');
        if(!hpInput || !maxInput) return;
    
        const hp = parseFloat(hpInput.value) || 0;
        const max = parseFloat(maxInput.value) || 1;
        const p = Math.max(0, Math.min(100, (hp / max) * 100));
    
        // 2. ë±ƒì§€(í…ìŠ¤íŠ¸ í‘œì‹œ) ì—…ë°ì´íŠ¸
        const badge = document.getElementById(`hpBadge_${id}`);
        if(badge) badge.textContent = `${hp.toFixed(0)}/${max.toFixed(0)}`;
    
        // 3. ì²´ë ¥ë°” ê¸¸ì´ ë° ìƒ‰ìƒ ì—…ë°ì´íŠ¸
        // ë°”ì˜ ID(hpBar_)ì™€ í´ë˜ìŠ¤(.hp-bar-fill ë˜ëŠ” .hp-bar-inner)ë¥¼ ë‘˜ ë‹¤ ì²´í¬
        const bar = document.getElementById(`hpBar_${id}`) || c.querySelector('.hp-bar-fill') || c.querySelector('.hp-bar-inner');
        
        if(bar) {
            bar.style.width = p + "%";
            
            // ìƒ‰ìƒ í´ë˜ìŠ¤ ì´ˆê¸°í™” í›„ ì¬ì„¤ì •
            bar.classList.remove('hp-safe', 'hp-warning', 'hp-danger');
            if (p > 70) bar.classList.add('hp-safe');
            else if (p > 30) bar.classList.add('hp-warning');
            else bar.classList.add('hp-danger');
        }
    
        // 4. ì‚¬ë§ ì²˜ë¦¬ (is-ko í´ë˜ìŠ¤)
        if(hp <= 0) c.classList.add('is-ko');
        else c.classList.remove('is-ko');
    
        // 5. ì‹¤ì‹œê°„ ë°ì´í„° ê³µìœ 
        if(b) broadcastData();
    }
    
    // [ì‹ ê·œ ìŠ¤í‚¬ ë©”ëª¨ ê¸°ëŠ¥ ë¡œì§]
    function addNewSkill() {
        const owner = selections.skillOwner, name = document.getElementById('skName').value, desc = document.getElementById('skDesc').value, type = document.getElementById('skType').value;
        if(!owner || !name) return alert("ìºë¦­í„°ì™€ ìŠ¤í‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
        skillData.push({ owner, name, desc, type });
        renderSkillList(); document.getElementById('skName').value = ""; document.getElementById('skDesc').value = "";
        broadcastData();
    }

    function renderSkillList() {
        const area = document.getElementById('skillListArea');
        if (!area) return;
    
        // 1. í˜„ì¬ ì–´ë–¤ ê·¸ë£¹ì´ ì—´ë ¤(block)ìˆëŠ”ì§€ ìƒíƒœë¥¼ ì €ì¥
        const openStates = {};
        document.querySelectorAll('.skill-group-content').forEach(el => {
            openStates[el.id] = el.style.display;
        });
    
        const grouped = skillData.reduce((acc, s) => { 
            if(!acc[s.owner]) acc[s.owner] = []; 
            acc[s.owner].push(s); 
            return acc; 
        }, {});
    
        area.innerHTML = Object.keys(grouped).map(owner => {
            const safeId = "skill_group_" + owner.replace(/\s+/g, '_');
            // 2. ì´ì „ì— ì—´ë ¤ìˆì—ˆìœ¼ë©´ ì—´ë¦° ìƒíƒœë¡œ, ê¸°ë¡ì´ ì—†ìœ¼ë©´(ìƒˆ ìºë¦­í„° ë“±) ê¸°ë³¸ì€ ë‹«í˜(none) ì²˜ë¦¬
            const currentDisplay = openStates[safeId] || 'none';
            
            return `
                <div class="skill-group" style="margin-bottom:8px; border:1px solid #eee; border-radius:4px; overflow:hidden; background:white;">
                    <div class="skill-group-header" 
                         onclick="const el = document.getElementById('${safeId}'); el.style.display = (el.style.display === 'none' ? 'block' : 'none');"
                         style="background:#f1f3f5; padding:10px; font-size:12px; font-weight:bold; cursor:pointer; display:flex; justify-content:space-between; border-bottom:1px solid #eee;">
                        <span>ğŸ‘¤ ${owner} <small style="color:#888; margin-left:5px;">(${grouped[owner].length})</small></span>
                        <span style="font-size:10px; color:#adb5bd;">í´ë¦­</span>
                    </div>
                    
                    <div id="${safeId}" class="skill-group-content" style="display:${currentDisplay};">
                        ${grouped[owner].map((s, idx) => {
                            const formattedDesc = s.desc.replace(/\n/g, '<br>');
                            // ìŠ¤í‚¬ íƒ€ì…ì— ë”°ë¥¸ í´ë˜ìŠ¤ ê²°ì • (ê³µë°± ì œê±°)
                            const typeClass = "sk-type-" + (s.type || "default").replace(/\s+/g, '');
                            // ìœ ì¼ ìˆ ì‹ì¼ ê²½ìš° ì´ë¦„ ì•ì— ì•„ì´ì½˜ ì¶”ê°€
                            const isUltimate = s.type === 'ìœ ì¼ìˆ ì‹' ? 'ğŸ”¥ ' : '';
    
                            return `
                            <div class="${typeClass}" style="padding:10px 12px; border-bottom:1px solid #f1f1f1; font-size:11px; position:relative; margin:2px 0;">
                                <b style="color:#6A5ACD; font-size:12px;">[${s.type}] ${s.name}</b>
                                <button class="admin-control" onclick="deleteSkill('${owner}', ${idx})" 
                                        style="position:absolute; top:8px; right:8px; color:#ff8787; background:none; border:none; font-size:14px;">Ã—</button>
                                <div style="color:#555; margin-top:6px; line-height:1.6;">${formattedDesc}</div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
        }).join('');
    }

    function deleteSkill(owner, idx) { 
        // ì‚­ì œ ì „ í™•ì¸ ì°½ (ì‹¤ìˆ˜ ë°©ì§€)
        if(!confirm(`[${owner}]ì˜ í•´ë‹¹ ìŠ¤í‚¬ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
        // 1. í•´ë‹¹ ìºë¦­í„°(owner)ì˜ ìŠ¤í‚¬ë“¤ë§Œ í•„í„°ë§
        const ownerSkills = skillData.filter(s => s.owner === owner);
        
        // 2. í•´ë‹¹ ìºë¦­í„°ì˜ ìŠ¤í‚¬ ë­‰ì¹˜ ì¤‘ í´ë¦­í•œ ìˆœì„œ(idx)ì˜ ìŠ¤í‚¬ ê°ì²´ë¥¼ íŠ¹ì •
        const targetSkill = ownerSkills[idx];
    
        if (targetSkill) {
            // 3. ì „ì²´ ë°ì´í„°(skillData)ì—ì„œ í•´ë‹¹ ìŠ¤í‚¬ ê°ì²´ì˜ ì§„ì§œ ì¸ë±ìŠ¤ë¥¼ ì°¾ìŒ
            const realIdx = skillData.indexOf(targetSkill);
            
            if (realIdx !== -1) {
                // 4. ì‹¤ì œ ë°ì´í„° ì‚­ì œ
                skillData.splice(realIdx, 1);
                
                // 5. í™”ë©´ ê°±ì‹  ë° ë°ì´í„° ë™ê¸°í™” (ê¸°ì¡´ í•¨ìˆ˜ë“¤ í˜¸ì¶œ)
                renderSkillList(); 
                if(typeof broadcastData === 'function') broadcastData();
                
                // ë¡œê·¸ ê¸°ë¡ (ì‹œìŠ¤í…œì— log í•¨ìˆ˜ê°€ ìˆì„ ê²½ìš°)
                if(typeof log === 'function') log(`ğŸ—‘ï¸ ${owner}ì˜ ìŠ¤í‚¬ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'log-dice');
            }
        }
    }
    
    // [í•„ìˆ˜ UI ë° ìœ í‹¸ - ì›ë³¸ ìœ ì§€]
    function log(m, t = '') { const a = document.getElementById('logArea'); const d = document.createElement('div'); d.className = `log-line ${t}`; d.innerHTML = m; a.prepend(d); }
    function startFirstTurn() { turnList = []; document.querySelectorAll('.char-card').forEach(c => { const id = c.id.split('_')[1], v = c.querySelector('.init-input').value; v.split(',').forEach(o => { const n = parseInt(o.trim()); if(!isNaN(n)) turnList.push({ id, order: n }); }); }); turnList.sort((a, b) => a.order - b.order); currentTurnPointer = 0; processNextTurn(); }
    function processEndPhase() { log(`â”â”â”â” ROUND ${round} ê²°ì‚° â”â”â”â”`, 'log-round-box'); document.querySelectorAll('.char-card').forEach(card => card.classList.remove('turn-ended', 'active-turn')); round++; document.getElementById('roundNum').textContent = round; currentTurnPointer = -1; broadcastData(); }
    function toggleCard(id, f) { const b = document.getElementById(`cardBody_${id}`), a = document.getElementById(`arrow_${id}`); if(!b) return; const ex = f !== undefined ? f : !b.classList.contains('expanded'); if(ex) { b.classList.add('expanded'); a.style.transform="rotate(180deg)"; } else { b.classList.remove('expanded'); a.style.transform="rotate(0deg)"; } }
    function toggleModal(id, sh) { document.getElementById(id).style.display = sh ? 'block' : 'none'; document.getElementById('overlay').style.display = sh ? 'block' : 'none'; }
    function closeAllModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); document.getElementById('overlay').style.display = 'none'; }
    function closeMenus() { document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display='none'); }
    function openSelect(e, id) { e.stopPropagation(); closeMenus(); document.getElementById(id).style.display='block'; refreshDropdowns(); }

    function getStatLabel(stat) {
        switch(stat) {
            case 'atk': return 'ê³µê²©ë ¥';
            case 'int': return 'ì§€ëŠ¥';
            case 'hit': return 'ëª…ì¤‘ë¥ ';
            case 'eva': return 'íšŒí”¼ìœ¨';
            case 'critR': return 'ì¹˜ëª…íƒ€ í™•ë¥ ';
            case 'critD': return 'ì¹˜ëª…íƒ€ ë°ë¯¸ì§€';
            case 'sp': return 'ì˜ë ¥';
            case 'healEff': return 'ì¹˜ë£Œíš¨ìœ¨';
            case 'hp': return 'í˜„ì¬ì²´ë ¥';
            case 'max': return 'ìµœëŒ€ì²´ë ¥';
            case 'dot': return 'ì§€ì†í”¼í•´';
            case 'hot': return 'ì§€ì†íšŒë³µ';
            case 'skip': return 'í–‰ë™ë¶ˆëŠ¥';
            case 'noheal': return 'ì¹˜ìœ ë¶ˆê°€';
            case 'reflect': return 'ë°˜ì‚¬';    
            case 'drain': return 'í¡í˜ˆ';     
            case 'none': return 'íŠ¹ìˆ˜íš¨ê³¼';    
            default: return stat;
        }
    }
    
    function getDefaultValue(s) { return {hit:100,critD:150,hp:100,max:100,atk:10,int:10,eva:0,critR:5,sp:10,healEff:100}[s] || 0; }
    function getModifiedStat(card, type) {
        let base = parseFloat(card.querySelector('.' + type).value), mod = 0;
        card.querySelectorAll('.status-badge').forEach(badge => {
            const stInput = badge.querySelector('.st-stack');
            if(stInput.dataset.stat === type) mod += (parseFloat(stInput.dataset.power) * parseInt(stInput.value));
        });
        return base * (1 + mod / 100);
    }
    function findCardByName(n) { 
    return Array.from(document.querySelectorAll('.char-card')).find(c => c.querySelector('.name-input').value === n);  
    }
    
    function refreshDropdowns() {
        const names = Array.from(document.querySelectorAll('.name-input')).map(i => i.value.trim());
        ['atkSrcList', 'atkTarList', 'healSrcList', 'healTarList', 'itemUserList', 'skillOwnerList'].forEach(id => {
            const list = document.getElementById(id); if(!list) return;
            const extra = (id === 'skillOwnerList') ? ["ê³µí†µ", ...names] : names;
            list.innerHTML = extra.map(n => `<div onclick="selectTarget('${id}', '${n}')">${n}</div>`).join("");
        });
        if(document.getElementById('itemSelList')) document.getElementById('itemSelList').innerHTML = itemTypes.map(it => `<div onclick="selectTarget('itemSelList', '${it.name}')">${it.name}</div>`).join("");
    }

    function selectTarget(listId, name) {
        if(listId === 'atkSrcList') { selections.atkSrc = name; document.getElementById('atkSrcBtn').textContent = name; }
        else if(listId === 'atkTarList') { if(!selections.atkTar.includes(name)) selections.atkTar.push(name); renderTags('atk'); }
        else if(listId === 'healSrcList') { selections.healSrc = name; document.getElementById('healSrcBtn').textContent = name; }
        else if(listId === 'healTarList') { if(!selections.healTar.includes(name)) selections.healTar.push(name); renderTags('heal'); }
        else if(listId === 'itemSelList') { selections.itemSel = name; document.getElementById('itemSelBtn').textContent = name; }
        else if(listId === 'itemUserList') { selections.itemUser = name; document.getElementById('itemUserBtn').textContent = name; }
        else if(listId === 'skillOwnerList') { selections.skillOwner = name; document.getElementById('skillOwnerBtn').textContent = name; }
        closeMenus();
    }
    function renderTags(m) { const area = document.getElementById(m + 'TarTags'); area.innerHTML = selections[m + 'Tar'].map(n => `<span class="target-tag">${n}<b onclick="removeTag('${m}', '${n}')">Ã—</b></span>`).join(""); }
    function removeTag(m, n) { selections[m + 'Tar'] = selections[m + 'Tar'].filter(x => x !== n); renderTags(m); }
    function openUnitStatusSelect(e, id) { e.stopPropagation(); closeMenus(); const m = document.getElementById(`unitStatusMenu_${id}`); m.innerHTML = statusTypes.map(s => `<div onclick="addStatusToUnit(${id}, '${s.name}', '${s.stat}', ${s.power}, ${s.turn})">${s.name}</div>`).join(""); m.style.display = 'block'; }

    // 1. ìƒíƒœì´ìƒ ì‹œê° íš¨ê³¼ ê°±ì‹  í•¨ìˆ˜ (í•„ìˆ˜!)
    function refreshStatusEffects(card) {
        if (!card) return;
        
        // ì´ì „ íš¨ê³¼ í´ë˜ìŠ¤ ì´ˆê¸°í™”
        card.classList.remove('card-disabled', 'border-elec', 'border-red', 'border-poison', 'border-corrupt');
    
        let hasDisable = false;
        let currentBorder = "";
    
        // ì¹´ë“œ ë‚´ ëª¨ë“  ìƒíƒœ ë°°ì§€ë¥¼ í™•ì¸
        card.querySelectorAll('.status-badge').forEach(badge => {
            const spanText = badge.querySelector('span').innerText;
    
            if (spanText.includes('ê°ì „')) currentBorder = 'border-elec';
            else if (spanText.includes('í™”ìƒ') || spanText.includes('ì¶œí˜ˆ')) currentBorder = 'border-red';
            else if (spanText.includes('ì¤‘ë…') || spanText.includes('ë…')) currentBorder = 'border-poison';
            else if (spanText.includes('ì˜¤ì—¼')) currentBorder = 'border-corrupt';
    
            // í–‰ë™ë¶ˆëŠ¥ ì²´í¬
            if (spanText.includes('ê¸°ì ˆ') || spanText.includes('ë¹™ê²°')) hasDisable = true;
        });
    
        if (hasDisable) card.classList.add('card-disabled');
        if (currentBorder) card.classList.add(currentBorder);
    }
    
    // 2. ìƒíƒœì´ìƒ ë¶€ì—¬ í•¨ìˆ˜ (ë¡œê·¸ ë° ì‹œê°íš¨ê³¼ í¬í•¨)
    function addStatusToUnit(id, name, stat, power, turn) {
        const c = document.getElementById(`unitActiveStatus_${id}`);
        const card = document.getElementById(`unitCard_${id}`); // ë§ˆìŠ¤í„°ë‹˜ì˜ ì¹´ë“œ ID í˜•ì‹ (unitCard_ìˆ«ì)
        if(!c || !card) return;
    
        const div = document.createElement('div');
        div.className = 'status-badge';
        
        // ë°°ì§€ ìƒì„± (ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹œê°íš¨ê³¼ ê°±ì‹  í¬í•¨)
        div.innerHTML = `<span>${name}${turn == 0 ? '(ì˜êµ¬)' : '('+turn+'T)'}</span>
            <div>
                <input type="number" value="1" class="st-stack" data-stat="${stat}" data-power="${power}" data-remain="${turn}" onchange="broadcastData()"> 
                <b onclick="if(isMaster){this.parentNode.parentNode.remove(); refreshStatusEffects(document.getElementById('unitCard_${id}')); broadcastData();}" style="color:red; cursor:pointer;">Ã—</b>
            </div>`;
        
        c.appendChild(div);
    
        // [ì¤‘ìš”] ìƒíƒœì´ìƒ ë¶€ì—¬ ì•Œë¦¼ ë¡œê·¸ ì¶œë ¥
        const unitName = card.querySelector('.name-input').value;
        const turnText = turn == 0 ? "ì˜êµ¬" : `${turn}í„´`;
        log(`âš ï¸ ${unitName}: [${name}] íš¨ê³¼ ë¶€ì—¬! (${turnText})`, 'log-dice');
    
        // ì‹œê° íš¨ê³¼ ì¦‰ì‹œ ë°˜ì˜
        refreshStatusEffects(card);
    
        closeMenus();
        broadcastData();
    }
    
    function rollDice() { const formula = document.getElementById('diceType').value || "1d100", success = parseInt(document.getElementById('diceSuccess').value); const parts = formula.toLowerCase().split('d'); let total = 0; if(parts.length === 2) { const count = parseInt(parts[0]) || 1, sides = parseInt(parts[1]) || 100; for(let i=0; i<count; i++) total += Math.floor(Math.random() * sides) + 1; } let msg = `ğŸ² ë‹¤ì´ìŠ¤: <b>${total}</b> (${formula})`; if(!isNaN(success)) msg += total <= success ? ` <span style="color:blue;">[ì„±ê³µ]</span>` : ` <span style="color:red;">[ì‹¤íŒ¨]</span>`; log(msg, 'log-dice'); }
    function addNewStatusType() { const n = document.getElementById('msName').value, s = document.getElementById('msStat').value, p = document.getElementById('msPower').value, t = document.getElementById('msTurn').value; if(!n || !p || t==="") return; statusTypes.push({ name:n, stat:s, power:p, turn: parseInt(t) }); renderStatusTypeList(); broadcastData(); }
    function renderStatusTypeList() { const list = document.getElementById('statusTypeList'); if(!list) return; list.innerHTML = statusTypes.map((s, idx) => `<div style="padding:6px; font-size:11px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><span><b>${s.name}</b> (${getStatLabel(s.stat)} ${s.power}${s.stat==='skip'?'':'%'})</span><button onclick="statusTypes.splice(${idx},1); renderStatusTypeList(); broadcastData();" style="color:red; background:none;">Ã—</button></div>`).join(""); }
    function addNewItemType() { const n = document.getElementById('itemName').value, p = document.getElementById('itemPower').value; if(!n || !p) return; itemTypes.push({ name:n, power:p }); renderItemTypeList(); refreshDropdowns(); broadcastData(); }
    function renderItemTypeList() { const list = document.getElementById('itemTypeList'); if(!list) return; list.innerHTML = itemTypes.map((it, idx) => `<div style="padding:4px; font-size:11px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">${it.name} (+${it.power}) <button onclick="itemTypes.splice(${idx},1); renderItemTypeList(); broadcastData();">Ã—</button></div>`).join(""); }
    function useItemNow() { const item = itemTypes.find(it => it.name === selections.itemSel), card = findCardByName(selections.itemUser); if(!item || !card) return; const hp = card.querySelector('.hp'), max = card.querySelector('.max'); hp.value = Math.min(parseFloat(max.value), parseFloat(hp.value) + parseFloat(item.power)).toFixed(1); log(`ğŸ’Š ${selections.itemUser}: [${item.name}] ì‚¬ìš©, <b>${item.power}</b> íšŒë³µ`, 'log-heal'); updateHP(card.id.split('_')[1]); toggleModal('useItemPopup', false); }
    
    function exportData() {
        const data = { round, statusTypes, itemTypes, skillData, units: [] };
        document.querySelectorAll('.char-card').forEach(card => {
            const stats = {}; card.querySelectorAll('.stat-grid input').forEach(i => { if(i.className) stats[i.className] = i.value; });
            const activeStatus = []; card.querySelectorAll('.status-badge').forEach(b => {
                const st = b.querySelector('.st-stack'); activeStatus.push({ name: b.querySelector('span').textContent.split('(')[0], stat: st.dataset.stat, power: st.dataset.power, stacks: st.value, remainTurn: st.dataset.remain });
            });
            data.units.push({ type: card.closest('.side-panel').querySelector('h5').textContent.includes('PLAYERS')?'player':'enemy', name: card.querySelector('.name-input').value, init: card.querySelector('.init-input').value, stats, activeStatus, isKO: card.classList.contains('is-ko'), isActive: card.classList.contains('active-turn'), isEnded: card.classList.contains('turn-ended') });
        });
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'})); a.download = `battle_save_v7.json`; a.click();
    }

    function importData(e) {
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader(); reader.onload = (re) => {
            const d = JSON.parse(re.target.result); document.getElementById('playerList').innerHTML = ''; document.getElementById('enemyList').innerHTML = '';
            unitIdx = 0; round = d.round || 1; document.getElementById('roundNum').textContent = round;
            statusTypes = d.statusTypes || []; itemTypes = d.itemTypes || []; skillData = d.skillData || [];
            renderStatusTypeList(); renderItemTypeList(); renderSkillList();
            if(d.units) d.units.forEach(u => createUnit(u.type, u));
            refreshDropdowns(); broadcastData();
        }; reader.readAsText(f);
    }

    function resetAllData() {
        if(!isMaster) return;
        
        if(confirm("ìœ ë‹›ì€ ìœ ì§€í•˜ê³  ë¼ìš´ë“œ, ìƒíƒœì´ìƒ, ë¡œê·¸ë§Œ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
            // 1. ë¼ìš´ë“œ ë° ì‹œìŠ¤í…œ ë°ì´í„° ì´ˆê¸°í™”
            round = 1;
            unitIdx = 0; // ì¸ë±ìŠ¤ëŠ” ì´ˆê¸°í™”í•´ë„ ìƒì„±ëœ ì¹´ë“œëŠ” ìœ ì§€ë©ë‹ˆë‹¤.
            // statusTypes, skillData ë“± ì„¤ì •ê°’ì€ ì´ˆê¸°í™”ì—ì„œ ì œì™¸í•˜ì—¬ ë“±ë¡ëœ ë¦¬ìŠ¤íŠ¸ë¥¼ ë³´ì¡´í•©ë‹ˆë‹¤.
    
            // 2. í™”ë©´ í‘œì‹œ ë° ë¡œê·¸ ì´ˆê¸°í™”
            document.getElementById('logArea').innerHTML = '';
            document.getElementById('roundNum').textContent = "1";
    
            // 3. [í•µì‹¬] ëª¨ë“  ìœ ë‹› ì¹´ë“œ ë‚´ë¶€ì˜ ìƒíƒœì´ìƒ ë° íš¨ê³¼ ì œê±°
            document.querySelectorAll('.char-card').forEach(card => {
                // A. ìƒíƒœì´ìƒ ë°°ì§€ ì œê±° (ë¶€ëª¨ ì»¨í…Œì´ë„ˆ ID: unitActiveStatus_ID)
                const id = card.id.split('_')[1];
                const statusContainer = document.getElementById(`unitActiveStatus_${id}`);
                if(statusContainer) statusContainer.innerHTML = '';
    
                // B. í„´ ê°•ì¡° ë° ìƒíƒœì´ìƒ ì‹œê° íš¨ê³¼ í´ë˜ìŠ¤ ì‹¹ ì œê±°
                card.classList.remove(
                    'turn-ended', 'active-turn', 'is-ko', 
                    'card-disabled', 'border-elec', 'border-red', 'border-poison', 'border-corrupt', 'shake-card'
                );
    
                // C. ì²´ë ¥ë°” ìƒ‰ìƒë„ ì•ˆì „(ë…¹ìƒ‰)ìœ¼ë¡œ ì´ˆê¸°í™” (ì„ íƒ ì‚¬í•­)
                const bar = document.getElementById(`hpBar_${id}`);
                if(bar) {
                    bar.classList.remove('hp-warning', 'hp-danger');
                    bar.classList.add('hp-safe');
                }
            });
    
            // 4. í„´ ê´€ë ¨ í¬ì¸í„° ì´ˆê¸°í™”
            currentTurnPointer = 0;
            if(typeof turnList !== 'undefined') turnList = [];
    
            log("ğŸ”„ ì „ì¥ì´ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ìœ ë‹›ì€ ìœ ì§€ë˜ë©° 1ë¼ìš´ë“œë¥¼ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.", 'log-round-box');
    
            broadcastData();
        }
    }    
    function broadcastData() { if(isMaster) socket.emit('battleUpdate', { round, statusTypes, itemTypes, skillData, htmlP: document.getElementById('playerList').innerHTML, htmlE: document.getElementById('enemyList').innerHTML, log: document.getElementById('logArea').innerHTML }); }
    socket.on('battleUpdate', (d) => {
        if(!isMaster) {
            round = d.round; document.getElementById('roundNum').textContent = round; statusTypes = d.statusTypes; itemTypes = d.itemTypes; skillData = d.skillData || [];
            document.getElementById('playerList').innerHTML = d.htmlP; document.getElementById('enemyList').innerHTML = d.htmlE; document.getElementById('logArea').innerHTML = d.log;
            renderStatusTypeList(); renderItemTypeList(); renderSkillList();
        }
    });
</script>
</body>
</html>
