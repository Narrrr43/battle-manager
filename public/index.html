<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Battle Manager v5.5 (Master Lock)</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5; --side-bg: #ffffff; --player-accent: #4361ee;
            --enemy-accent: #e63946; --heal-accent: #2a9d8f; --dice-accent: #8e44ad;
            --turn-active: #00d2ff; --text-main: #2d3436; --border: #dfe6e9;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Pretendard', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .side-panel { width: 350px; display: flex; flex-direction: column; background: var(--side-bg); border: 1px solid var(--border); }
        .char-scroll-area { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; }
        .center-panel { flex: 1; display: flex; flex-direction: column; padding: 12px; gap: 10px; overflow: hidden; }
        .char-card { background: #fff; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; transition: all 0.3s ease; }
        .char-card.active-turn { border: 3px solid var(--turn-active); box-shadow: 0 0 15px rgba(0, 210, 255, 0.5); transform: scale(1.02); z-index: 5; }
        .char-card.turn-ended { opacity: 0.5; background: #f8f9fa; }
        .char-card.is-ko { filter: grayscale(1); opacity: 0.5; pointer-events: none; }
        .ko-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); background: rgba(0,0,0,0.8); color: white; padding: 5px 15px; border: 2px solid red; font-weight: 900; z-index: 100; display: none; }
        .char-card.is-ko .ko-badge { display: block; }
        .card-header { padding: 12px; cursor: pointer; display: flex; flex-direction: column; }
        .card-body { overflow: hidden; max-height: 0; transition: max-height 0.4s ease; padding: 0 12px; opacity: 0; visibility: hidden; }
        .card-body.expanded { max-height: 2000px; padding: 12px; border-top: 1px solid #f1f1f1; opacity: 1; visibility: visible; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 12px; }
        .stat-item { display: flex; align-items: center; justify-content: space-between; font-size: 11px; }
        .stat-item input { width: 42px; border: none; border-bottom: 1px solid #ddd; text-align: right; font-weight: 600; }
        .init-input { width: 60px !important; color: var(--turn-active); border-bottom: 2px solid var(--turn-active) !important; font-weight: 900 !important; text-align: center; }
        .hp-bar-outer { width: 100%; height: 4px; background: #eee; border-radius: 8px; margin-top: 5px; }
        .hp-bar-inner { height: 100%; width: 100%; transition: 0.3s; }
        .turn-display { background: #2d3436; color: white; padding: 8px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .log-area { flex: 1; background: #fff; border-radius: 10px; padding: 10px; overflow-y: auto; border: 2px solid var(--border); font-size: 13px; }
        .log-line { margin-bottom: 4px; padding: 2px 5px; border-radius: 4px; border-left: 3px solid transparent; }
        .log-round-box { background: #2d3436; color: #fff; padding: 8px; margin: 10px 0; border-radius: 6px; text-align: center; font-weight: 800; }
        .control-row { display: flex; gap: 8px; height: 180px; }
        .control-box { flex: 1; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; position: relative; }
        .custom-select { width: 100%; padding: 6px; border: 1px solid #eee; border-radius: 5px; margin-bottom: 4px; font-size: 11px; cursor: pointer; background: #f9f9f9; }
        .dropdown-menu { display: none; position: absolute; background: #fff; width: 140px; z-index: 500; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; }
        .dropdown-menu div { padding: 6px; cursor: pointer; font-size: 11px; border-bottom: 1px solid #eee; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 380px; background: white; z-index: 1000; border-radius: 12px; padding: 18px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index: 999; display: none; }
        button { cursor: pointer; border: none; font-weight: 700; border-radius: 5px; }
        .btn-action { width: 100%; padding: 8px; color: white; margin-top: auto; font-size: 11px; }
        .status-badge { display: flex; justify-content: space-between; background: #f1f2f6; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-bottom: 2px; }
        
        /* [ë§ˆìŠ¤í„° ê¶Œí•œìš© ìŠ¤íƒ€ì¼] */
        .is-viewer button, .is-viewer .custom-select { pointer-events: none; opacity: 0.6; }
        #masterBadge { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 2000; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .admin-only { background: var(--turn-active); color: #000; }
        .viewer-only { background: #636e72; color: #fff; }
    </style>
</head>
<body onclick="closeMenus()" class="is-viewer"> <div id="masterBadge" class="viewer-only" onclick="askMasterPassword()">ğŸ‘€ ê´€ì „ì ëª¨ë“œ (ì¸ì¦í•˜ë ¤ë©´ í´ë¦­)</div>
<div class="overlay" id="overlay"></div>

<div id="statusManagerMenu" class="modal">
    <h4 style="margin:0 0 10px 0;">âœ¨ ìƒíƒœì´ìƒ ë“±ë¡</h4>
    <div style="display:flex; flex-direction:column; gap:6px;">
        <input type="text" id="msName" placeholder="ì´ë¦„" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
        <select id="msStat" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
            <option value="atk">ê³µê²©ë ¥ %</option><option value="hit">ëª…ì¤‘ %</option><option value="eva">íšŒí”¼ %</option><option value="dot">ì§€ì†í”¼í•´(%)</option>
        </select>
        <input type="number" id="msPower" placeholder="ìˆ˜ì¹˜" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
        <input type="number" id="msTurn" placeholder="ì§€ì†í„´" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
        <button onclick="addNewStatusType(); broadcastData();" style="background:var(--player-accent); color:white; padding:10px;">ë“±ë¡</button>
    </div>
    <div id="statusTypeList" style="margin-top:10px; max-height:100px; overflow-y:auto;"></div>
    <button onclick="toggleModal('statusManagerMenu', false)" style="width:100%; margin-top:10px;">ë‹«ê¸°</button>
</div>

<div id="itemManagerMenu" class="modal">
    <h4 style="margin:0 0 10px 0;">ğŸ’Š ì•„ì´í…œ ë“±ë¡</h4>
    <div style="display:flex; flex-direction:column; gap:6px;">
        <input type="text" id="itemName" placeholder="ì´ë¦„">
        <input type="number" id="itemPower" placeholder="íšŒë³µëŸ‰">
        <button onclick="addNewItemType(); broadcastData();" style="background:var(--heal-accent); color:white; padding:10px;">ë“±ë¡</button>
    </div>
    <div id="itemTypeList" style="margin-top:10px; max-height:100px; overflow-y:auto;"></div>
    <button onclick="toggleModal('itemManagerMenu', false)" style="width:100%; margin-top:10px;">ë‹«ê¸°</button>
</div>

<div id="useItemPopup" class="modal">
    <h4 style="margin:0 0 10px 0;">ğŸ‘œ ì•„ì´í…œ ì‚¬ìš©</h4>
    <div class="custom-select" onclick="openSelect(event, 'itemSelList')" id="itemSelBtn">ì•„ì´í…œ ì„ íƒ</div>
    <div id="itemSelList" class="dropdown-menu"></div>
    <div class="custom-select" onclick="openSelect(event, 'itemUserList')" id="itemUserBtn">ëŒ€ìƒì</div>
    <div id="itemUserList" class="dropdown-menu"></div>
    <button onclick="useItemNow()" style="width:100%; background:var(--heal-accent); color:white; padding:10px; margin-top:10px;">ì¦‰ì‹œ ì‚¬ìš©</button>
    <button onclick="toggleModal('useItemPopup', false)" style="width:100%; margin-top:5px;">ì·¨ì†Œ</button>
</div>

<div class="side-panel">
    <div class="panel-header" style="padding:10px; display:flex; justify-content:space-between;">
        <h5 style="margin:0; color:var(--player-accent);">PLAYERS</h5>
        <button onclick="createUnit('player'); broadcastData();">+</button>
    </div>
    <div id="playerList" class="char-scroll-area"></div>
</div>

<div class="center-panel">
    <div class="turn-display">
        <div><b>ROUND <span id="roundNum">1</span></b> <button onclick="startFirstTurn()">ì „íˆ¬ ì‹œì‘</button></div>
        <button onclick="processEndPhase()">ë¼ìš´ë“œ ê²°ì‚° & ì¢…ë£Œ</button>
    </div>
    <div class="control-row">
        <div class="control-box">
            <h6 style="margin:0; color:var(--enemy-accent);">âš”ï¸ ATTACK</h6>
            <div class="custom-select" onclick="openSelect(event, 'atkSrcList')" id="atkSrcBtn">ê³µê²©ì</div>
            <div id="atkSrcList" class="dropdown-menu"></div>
            <div class="custom-select" onclick="openSelect(event, 'atkTarList')" id="atkTarBtn">ëŒ€ìƒ ì¶”ê°€</div>
            <div id="atkTarList" class="dropdown-menu"></div>
            <div id="atkTarTags"></div>
            <button class="btn-action" style="background:#2d3436;" onclick="executeAction('attack')">BASIC ATTACK</button>
        </div>
        <div class="control-box" style="border: 2px dashed var(--dice-accent);">
            <h6 style="margin:0; color:var(--dice-accent);">ğŸ² DICE</h6>
            <input type="text" id="diceType" placeholder="1d100" style="width:100%; text-align:center; margin-bottom:5px;">
            <button class="btn-action" style="background:var(--dice-accent);" onclick="rollDice()">ROLL</button>
        </div>
        <div class="control-box">
            <h6 style="margin:0; color:var(--heal-accent);">â¤ï¸ HEAL</h6>
            <div class="custom-select" onclick="openSelect(event, 'healSrcList')" id="healSrcBtn">ì¹˜ë£Œì</div>
            <div id="healSrcList" class="dropdown-menu"></div>
            <div class="custom-select" onclick="openSelect(event, 'healTarList')" id="healTarBtn">ëŒ€ìƒ ì¶”ê°€</div>
            <div id="healTarList" class="dropdown-menu"></div>
            <div id="healTarTags"></div>
            <button class="btn-action" style="background:var(--heal-accent);" onclick="executeAction('heal')">HEAL</button>
        </div>
    </div>
    <div style="display:flex; gap:5px; background:white; padding:8px; border-radius:10px;">
        <button onclick="toggleModal('statusManagerMenu', true)" style="flex:1;">âš™ï¸ ìƒíƒœì´ìƒ</button>
        <button onclick="toggleModal('itemManagerMenu', true)" style="flex:1;">ğŸ’Š ì•„ì´í…œì„¤ì •</button>
        <button onclick="toggleModal('useItemPopup', true)" style="flex:1.5;">ğŸ‘œ ì•„ì´í…œì‚¬ìš©</button>
    </div>
    <div class="log-area" id="logArea"></div>
</div>

<div class="side-panel">
    <div class="panel-header" style="padding:10px; display:flex; justify-content:space-between;">
        <h5 style="margin:0; color:var(--enemy-accent);">ENEMIES</h5>
        <button onclick="createUnit('enemy'); broadcastData();">+</button>
    </div>
    <div id="enemyList" class="char-scroll-area"></div>
</div>

<script>
    const socket = io();
    const MASTER_PW = "qazplm10110925";
    let isMaster = false;
    let unitIdx = 0; let round = 1; let statusTypes = []; let itemTypes = [];
    let selections = { atkSrc: "", atkTar: [], healSrc: "", healTar: [], itemSel: "", itemUser: "" };
    let turnList = []; let currentTurnPointer = -1;

    function askMasterPassword() {
        const pw = prompt("ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (pw === MASTER_PW) {
            isMaster = true; document.body.classList.remove('is-viewer');
            const badge = document.getElementById('masterBadge');
            badge.textContent = "ğŸ‘‘ ë§ˆìŠ¤í„° ê¶Œí•œ í™œì„±í™”"; badge.className = "admin-only";
            alert("ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else { alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); }
    }

    function broadcastData() {
        if (!isMaster) return;
        const data = {
            round: round, logHtml: document.getElementById('logArea').innerHTML,
            statusTypes: statusTypes, itemTypes: itemTypes, units: []
        };
        document.querySelectorAll('.char-card').forEach(card => {
            const stats = {}; card.querySelectorAll('.stat-grid input').forEach(i => { if(i.className) stats[i.className] = i.value; });
            const activeStatus = []; card.querySelectorAll('.status-badge').forEach(b => {
                const st = b.querySelector('.st-stack');
                activeStatus.push({ name: b.querySelector('span').textContent.split('(')[0], stat: st.dataset.stat, power: st.dataset.power, stacks: st.value, remainTurn: st.dataset.remain });
            });
            data.units.push({
                type: card.closest('.side-panel').querySelector('h5').textContent.includes('PLAYERS') ? 'player' : 'enemy',
                name: card.querySelector('.name-input').value, init: card.querySelector('.init-input').value,
                stats: stats, activeStatus: activeStatus, isKO: card.classList.contains('is-ko'),
                isActive: card.classList.contains('active-turn'), isEnded: card.classList.contains('turn-ended')
            });
        });
        socket.emit('sync_to_server', data);
    }

    socket.on('update_from_server', (data) => {
        round = data.round; document.getElementById('roundNum').textContent = round;
        document.getElementById('logArea').innerHTML = data.logHtml;
        statusTypes = data.statusTypes || []; itemTypes = data.itemTypes || [];
        renderStatusTypeList(); renderItemTypeList();
        document.getElementById('playerList').innerHTML = ''; document.getElementById('enemyList').innerHTML = '';
        data.units.forEach(u => createUnit(u.type, u));
    });

    function log(msg, type = '') {
        const area = document.getElementById('logArea'); const div = document.createElement('div');
        div.className = `log-line ${type}`; div.innerHTML = msg; area.prepend(div);
        broadcastData();
    }

    function createUnit(type, savedData = null) {
        unitIdx++; const currentId = unitIdx;
        const container = document.getElementById(type === 'player' ? 'playerList' : 'enemyList');
        const card = document.createElement('div'); card.className = 'char-card';
        if(savedData?.isKO) card.classList.add('is-ko');
        if(savedData?.isActive) card.classList.add('active-turn');
        if(savedData?.isEnded) card.classList.add('turn-ended');
        card.id = `unitCard_${currentId}`;
        const ro = isMaster ? "" : "readonly";

        card.innerHTML = `
            <div class="ko-badge">ì „íˆ¬ ë¶ˆëŠ¥</div>
            <div class="card-header" onclick="toggleCard(${currentId})">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <input type="text" class="init-input" value="${savedData?.init || '1'}" onchange="broadcastData()" onclick="event.stopPropagation()" ${ro}>
                    <input type="text" class="name-input" value="${savedData?.name || (type==='player'?'P':'E')+'-'+currentId}" onclick="event.stopPropagation()" onchange="refreshDropdowns(); broadcastData();" style="border:none; font-weight:800; width:80px;" ${ro}>
                    <span id="hpBadge_${currentId}" style="font-size:10px;">100/100</span>
                </div>
                <div class="hp-bar-outer"><div class="hp-bar-inner" id="hpBar_${currentId}" style="background:var(--heal-accent)"></div></div>
            </div>
            <div class="card-body" id="cardBody_${currentId}">
                <div class="stat-grid">
                    ${['atk','int','hit','eva','critR','critD','sp','healEff','hp','max'].map(s => `
                        <div class="stat-item"><label>${getStatLabel(s)}</label><input type="number" class="${s}" value="${savedData ? savedData.stats[s] : getDefaultValue(s)}" oninput="updateHP(${currentId})" ${ro}></div>
                    `).join('')}
                </div>
                <div style="margin-top:10px; display:flex; gap:5px;">
                    <button onclick="finishCurrentTurn(${currentId})" style="flex:1.2; background:var(--turn-active); padding:8px;">í–‰ë™ ì™„ë£Œ</button>
                    <button onclick="executeBonusAtk(${currentId})" style="flex:1; background:#ff7675; color:white;">ì¶”ê°€í”¼í•´%</button>
                    <input type="number" class="bonus-dmg-input" value="0" style="width:40px;" ${ro}>
                </div>
                <div id="unitActiveStatus_${currentId}" style="margin-top:5px;"></div>
                <button onclick="openUnitStatusSelect(event, ${currentId})" style="width:100%; font-size:10px; margin-top:5px;">+ ìƒíƒœì´ìƒ ë¶€ì—¬</button>
                <div id="unitStatusMenu_${currentId}" class="dropdown-menu"></div>
            </div>
        `;
        container.appendChild(card);
        if(savedData?.activeStatus) {
            savedData.activeStatus.forEach(st => {
                const b = document.createElement('div'); b.className = 'status-badge';
                b.innerHTML = `<span>${st.name}(${st.remainTurn}T)</span><div><input type="number" value="${st.stacks}" class="st-stack" data-stat="${st.stat}" data-power="${st.power}" data-remain="${st.remainTurn}" onchange="broadcastData()" ${ro}> <b onclick="if(isMaster){this.parentNode.parentNode.remove(); broadcastData();}" style="color:red; cursor:pointer;">Ã—</b></div>`;
                card.querySelector(`#unitActiveStatus_${currentId}`).appendChild(b);
            });
        }
        updateHP(currentId, false); refreshDropdowns();
    }

    function startFirstTurn() {
        turnList = []; document.querySelectorAll('.char-card').forEach(card => {
            const id = card.id.split('_')[1]; const initVal = card.querySelector('.init-input').value;
            initVal.split(',').forEach(v => { const o = parseInt(v.trim()); if(!isNaN(o)) turnList.push({ id, order: o }); });
            card.classList.remove('turn-ended', 'active-turn');
        });
        turnList.sort((a, b) => a.order - b.order); currentTurnPointer = 0; processNextTurn();
    }
    function processNextTurn() {
        document.querySelectorAll('.char-card').forEach(c => c.classList.remove('active-turn'));
        if(currentTurnPointer >= turnList.length) return log("ğŸ ë¼ìš´ë“œ ì¢…ë£Œ.");
        const cur = turnList[currentTurnPointer]; const card = document.getElementById(`unitCard_${cur.id}`);
        if(card.classList.contains('is-ko')) { currentTurnPointer++; return processNextTurn(); }
        card.classList.add('active-turn'); card.classList.remove('turn-ended'); toggleCard(cur.id, true);
        log(`â–¶ [${cur.order}] **${card.querySelector('.name-input').value}** ì°¨ë¡€`, 'log-dice'); broadcastData();
    }
    function finishCurrentTurn(id) {
        document.getElementById(`unitCard_${id}`).classList.remove('active-turn');
        if(!turnList.slice(currentTurnPointer+1).some(t => t.id == id)) document.getElementById(`unitCard_${id}`).classList.add('turn-ended');
        currentTurnPointer++; processNextTurn();
    }
    function executeAction(mode) {
        const src = mode === 'attack' ? selections.atkSrc : selections.healSrc;
        const tars = mode === 'attack' ? selections.atkTar : selections.healTar;
        const sCard = findCardByName(src); if(!sCard || tars.length === 0) return alert("ì„ íƒ í™•ì¸!");
        tars.forEach(tName => {
            const tCard = findCardByName(tName); if(!tCard) return;
            if(mode === 'attack') {
                const atk = getModifiedStat(sCard, 'atk'), sp = parseFloat(sCard.querySelector('.sp').value);
                let dmg = (atk * (sp/3)) * (sp*0.2) * (0.9 + Math.random()*0.2);
                tCard.querySelector('.hp').value = Math.max(0, parseFloat(tCard.querySelector('.hp').value) - dmg).toFixed(1);
                updateHP(tCard.id.split('_')[1]); log(`${src} â†’ ${tName} : <b>${dmg.toFixed(1)}</b> í”¼í•´`, 'log-atk');
            } else {
                const intel = getModifiedStat(sCard, 'int'), eff = parseFloat(sCard.querySelector('.healEff').value);
                let h = ((intel * eff) / 5) * (0.9 + Math.random()*0.2);
                tCard.querySelector('.hp').value = Math.min(parseFloat(tCard.querySelector('.max').value), parseFloat(tCard.querySelector('.hp').value) + h).toFixed(1);
                updateHP(tCard.id.split('_')[1]); log(`${src} â†’ ${tName} : <b>${h.toFixed(1)}</b> íšŒë³µ`, 'log-heal');
            }
        });
    }
    function executeBonusAtk(uId) {
        const card = document.getElementById(`unitCard_${uId}`);
        const r = parseFloat(card.querySelector('.bonus-dmg-input').value) || 0;
        selections.atkTar.forEach(tName => {
            const tCard = findCardByName(tName); if(!tCard) return;
            let d = (getModifiedStat(card, 'atk') * (r/100));
            tCard.querySelector('.hp').value = Math.max(0, parseFloat(tCard.querySelector('.hp').value) - d).toFixed(1);
            updateHP(tCard.id.split('_')[1]); log(`[ì¶”ê°€] ${tName} <b>${d.toFixed(1)}</b> í”¼í•´`, 'log-atk');
        });
    }
    function processEndPhase() {
        log(`â”â”â”â” ROUND ${round} ì¢…ë£Œ â”â”â”â”`, 'log-round-box');
        document.querySelectorAll('.char-card').forEach(card => {
            if(card.classList.contains('is-ko')) return;
            const max = parseFloat(card.querySelector('.max').value); let dot = 0;
            card.querySelectorAll('.st-stack').forEach(st => {
                if(st.dataset.stat === 'dot') dot += (max * (parseFloat(st.dataset.power)/100)) * parseInt(st.value);
                let rem = parseInt(st.dataset.remain); if(rem > 0) {
                    rem--; st.dataset.remain = rem; const b = st.closest('.status-badge');
                    if(rem === 0) b.remove(); else b.querySelector('span').textContent = `${b.querySelector('span').textContent.split('(')[0]}(${rem}T)`;
                }
            });
            if(dot > 0) { card.querySelector('.hp').value = Math.max(0, parseFloat(card.querySelector('.hp').value) - dot).toFixed(1); updateHP(card.id.split('_')[1]); }
            card.classList.remove('turn-ended', 'active-turn');
        });
        round++; document.getElementById('roundNum').textContent = round; currentTurnPointer = -1; broadcastData();
    }
    function updateHP(id, b = true) {
        const card = document.getElementById(`unitCard_${id}`); const hp = parseFloat(card.querySelector('.hp').value), max = parseFloat(card.querySelector('.max').value);
        const p = Math.max(0, Math.min(100, (hp/max)*100));
        document.getElementById(`hpBadge_${id}`).textContent = `${hp.toFixed(0)}/${max.toFixed(0)}`;
        document.getElementById(`hpBar_${id}`).style.width = p+"%";
        if(hp <= 0) card.classList.add('is-ko'); else card.classList.remove('is-ko');
        if(b) broadcastData();
    }
    function getModifiedStat(c, s) {
        let val = parseFloat(c.querySelector('.'+s).value), m = 0;
        c.querySelectorAll('.st-stack').forEach(i => { if(i.dataset.stat === s) m += (parseInt(i.value) * parseFloat(i.dataset.power)); });
        return val * (1 + (m/100));
    }
    function toggleCard(id, f) {
        const b = document.getElementById(`cardBody_${id}`);
        if(f !== undefined) { if(f) b.classList.add('expanded'); else b.classList.remove('expanded'); }
        else b.classList.toggle('expanded');
    }
    function openSelect(e, id) { e.stopPropagation(); closeMenus(); document.getElementById(id).style.display='block'; refreshDropdowns(); }
    function closeMenus() { document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display='none'); }
    function refreshDropdowns() {
        const names = Array.from(document.querySelectorAll('.name-input')).map(i => i.value.trim());
        ['atkSrcList', 'atkTarList', 'healSrcList', 'healTarList', 'itemUserList', 'itemSelList'].forEach(id => {
            const list = document.getElementById(id); list.innerHTML = "";
            (id === 'itemSelList' ? itemTypes.map(i=>i.name) : names).forEach(n => {
                const d = document.createElement('div'); d.textContent = n;
                d.onclick = () => {
                    const key = id.replace('List', '');
                    if(id.includes('Src') || id.includes('User') || id.includes('Sel')) { selections[key] = n; document.getElementById(key+'Btn').textContent = n; }
                    else { if(!selections[key].includes(n)) selections[key].push(n); renderTags(key); }
                }; list.appendChild(d);
            });
        });
    }
    function renderTags(k) { document.getElementById(k+'Tags').innerHTML = selections[k].map(n => `<span style="font-size:10px; background:#eee; padding:2px; margin:2px;">${n}<b onclick="selections['${k}']=selections['${k}'].filter(t=>t!=='${n}'); renderTags('${k}')">Ã—</b></span>`).join(""); }
    function findCardByName(n) { return [...document.querySelectorAll('.char-card')].find(c => c.querySelector('.name-input').value === n); }
    function toggleModal(id, sh) { document.getElementById(id).style.display = sh ? 'block' : 'none'; document.getElementById('overlay').style.display = sh ? 'block' : 'none'; }
    function rollDice() { const t = document.getElementById('diceType').value || "1d100"; const m = t.match(/(\d+)d(\d+)/); if(!m) return; let res = 0; for(let i=0; i<m[1]; i++) res += Math.floor(Math.random()*m[2])+1; log(`ğŸ² ${t} ê²°ê³¼: <b>${res}</b>`, 'log-dice'); }
    function addNewStatusType() { statusTypes.push({ name: document.getElementById('msName').value, stat: document.getElementById('msStat').value, power: parseFloat(document.getElementById('msPower').value), turn: parseInt(document.getElementById('msTurn').value) }); renderStatusTypeList(); }
    function renderStatusTypeList() { document.getElementById('statusTypeList').innerHTML = statusTypes.map((s, idx) => `<div style="font-size:11px;">${s.name} <button onclick="statusTypes.splice(${idx},1); renderStatusTypeList();">Ã—</button></div>`).join(""); }
    function openUnitStatusSelect(e, id) { e.stopPropagation(); closeMenus(); const m = document.getElementById(`unitStatusMenu_${id}`); m.innerHTML = statusTypes.map((s, idx) => `<div onclick="applyStatus(${id}, ${idx})">${s.name}</div>`).join(""); m.style.display='block'; }
    function applyStatus(uId, sIdx) {
        const s = statusTypes[sIdx]; const b = document.createElement('div'); b.className = 'status-badge';
        b.innerHTML = `<span>${s.name}(${s.turn}T)</span><div><input type="number" value="1" class="st-stack" data-stat="${s.stat}" data-power="${s.power}" data-remain="${s.turn}" onchange="broadcastData()"> <b onclick="if(isMaster){this.parentNode.parentNode.remove(); broadcastData();}" style="color:red;">Ã—</b></div>`;
        document.getElementById(`unitCard_${uId}`).querySelector(`#unitActiveStatus_${uId}`).appendChild(b); broadcastData();
    }
    function addNewItemType() { itemTypes.push({ name: document.getElementById('itemName').value, power: parseFloat(document.getElementById('itemPower').value) }); renderItemTypeList(); }
    function renderItemTypeList() { document.getElementById('itemTypeList').innerHTML = itemTypes.map((it, idx) => `<div style="font-size:11px;">${it.name} <button onclick="itemTypes.splice(${idx},1); renderItemTypeList();">Ã—</button></div>`).join(""); }
    function useItemNow() {
        const it = itemTypes.find(i=>i.name===selections.itemSel); const c = findCardByName(selections.itemUser); if(!it || !c) return;
        c.querySelector('.hp').value = Math.min(parseFloat(c.querySelector('.max').value), parseFloat(c.querySelector('.hp').value) + it.power).toFixed(1);
        updateHP(c.id.split('_')[1]); log(`ğŸ’Š ${selections.itemUser} ${it.name} ì‚¬ìš©`, 'log-heal'); toggleModal('useItemPopup', false);
    }
    function getStatLabel(s) { const l = {atk:'ê³µê²©', int:'ì§€ëŠ¥', hit:'ëª…ì¤‘', eva:'íšŒí”¼', critR:'ì¹˜ëª…', critD:'í¬ë€', sp:'ì˜ë ¥', healEff:'ì¹˜ë£Œ', hp:'í˜„ì¬HP', max:'ìµœëŒ€HP'}; return l[s]; }
    function getDefaultValue(s) { const d = {atk:50, int:20, hit:80, eva:15, critR:20, critD:150, sp:5, healEff:10, hp:100, max:100}; return d[s]; }

    createUnit('player'); createUnit('enemy');
</script>
</body>
</html>
